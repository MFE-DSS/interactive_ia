"use strict";(globalThis.__LOADABLE_LOADED_CHUNKS__=globalThis.__LOADABLE_LOADED_CHUNKS__||[]).push([[61397],{6487:(e,t,i)=>{function s(e,t=!0){const i=(e=e.filter(Boolean)).reduce(((e,t)=>e+t.length),0)+4*e.length,s=new Uint8Array(i);return e.reduce(((e,i)=>{if(t){const t=new DataView(new ArrayBuffer(4));t.setUint32(0,i.length,!1),s.set(new Uint8Array(t.buffer),e)}else s.set(new Uint8Array([0,0,0,1]),e);return e+=4,s.set(i,e),e+i.length}),0),s}function a(){return typeof MediaStreamTrackGenerator<"u"&&typeof VideoDecoder<"u"&&typeof AudioDecoder<"u"&&typeof EncodedVideoChunk<"u"&&typeof EncodedAudioChunk<"u"}i.d(t,{A:()=>l});const r={codec:"hev1.1.6.L93.B0",width:516,height:360,description:new Uint8Array([1,1,96,0,0,0,144,0,0,0,0,0,93,240,0,252,253,248,248,0,0,15,3,160,0,1,0,24,64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,149,152,9,161,0,1,0,46,66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,4,18,1,105,223,150,86,105,36,202,255,240,8,112,21,134,128,128,0,0,3,0,128,0,0,15,4,162,0,1,0,7,68,1,193,114,180,98,64]),vps:new Uint8Array([64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,149,152,9]),sps:new Uint8Array([66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,4,18,1,105,223,150,86,105,36,202,255,240,8,112,21,134,128,128,0,0,3,0,128,0,0,15,4]),pps:new Uint8Array([68,1,193,114,180,98,64]),keyframe:new Uint8Array([40,1,175,5,19,10,4,204,107,162,197,86,96,253,1,104,127,243,108,50,227,223,104,33,163,117,1,130,0,0,3,2,246,162,132,152,167,55,239,108,150,33,9,29,123,71,181,135,189,219,199,75,108,47,232,96,249,29,139,87,142,12,105,105,239,222,134,140,55,236,191,32,207,197,250,20,113,206,125,174,26,227,13,206,136,173,25,195,250,252,41,177,114,131,101,160,248,135,227,1,16,31,200,113,228,160,110,63,221,250,192,177,169,229,147,150,215,57,193,166,102,41,250,181,156,90,210,34,41,138,94,231,91,154,111,60,218,230,63,53,68,240,12,223,125,179,190,169,248,174,32,212,151,65,59,130,102,103,84,81,129,180,0,219,213,34,192,37,201,68,193,193,10,82,197,157,6,116,53,69,212,145,216,102,173,182,50,147,169,101,176,97,58,179,38,103,10,131,202,84,91,253,194,141,94,118,68,71,180,169,155,222,16,166,86,171,96,60,110,131,187,240,22,69,130,200,0,0,3,0,66,192,147,37,106,36,81,215,169,162,97,132,15,84,207,166,187,31,45,160,113,184,125,143,226,44,207,141,196,26,203,25,246,79,232,88,83,8,171,91,82,71,73,28,48,95,163,17,76,204,112,72,242,176,230,172,184,154,129,130,224,119,161,68,178,53,83,43,80,125,24,208,50,164,35,8,137,96,64,149,143,249,96,8,199,11,130,102,242,207,139,180,48,214,152,251,176,229,252,35,107,167,89,122,29,65,68,191,123,89,68,129,6,213,244,241,0,187,63,49,165,162,0,41,213,114,236,193,2,72,132,97,184,223,188,79,64,218,6,252,68,172,26,66,70,107,171,145,55,152,132,160,218,146,101,15,12,37,215,231,221,93,136,153,3,220,56,15,231,226,96,11,15,223,144,193,8,204,199,148,146,148,200,38,118,172,71,77,219,232,94,18,29,11,161,82,89,171,24,56,231,175,238,103,8,164,137,83,20,196,164,236,193,68,233,61,16,212,104,211,68,65,234,101,163,81,165,51,127,160,66,9,225,244,89,174,86,45,197,130,218,61,192,45,121,4,36,208,242,220,201,166,193,249,201,144,132,97,81,180,109,117,119,63,7,105,96,15,35,76,253,67,202,189,8,87,41,252,2,221,85,58,32,143,116,154,18,178,8,246,102,61,149,55,212,74,3,198,228,16,151,250,147,162,79,118,231,62,124,211,20,87,253,40,145,174,111,200,42,187,153,185,163,8,76,203,244,186,11,255,146,41,34,149,221,122,192,4,207,43,209,208,161,137,214,77,169,168,42,171,178,39,220,172,193,132,83,41,152,25,56,235,4,225,102,60,241,20,233,136,72,234,111,32,36,180,0,154,191,155,183,170,25,58,247,138,137,45,219,185,159,187,160,128,83,156,165,25,84,184,200,221,68,75,244,167,187,169,103,238,255,119,23,207,223,145,121,205,150,87,107,217,245,140,26,242,171,150,111,72,100,149,58,172,144,129,209,63,238,20,54,108,228,230,129,0,187,112,120,87,146,116,197,36,104,31,247,204,212,233,118,61,184,182,193,136,81,193,92,164,184,186,199,219,27,94,166,100,59,11,187,213,57,95,247,76,71,82,69,20,156,67,2,161,217,238,95,119,159,202,229,97,72,118,34,121,213,167,19,253,184,150,229,90,81,69,27,178,121,12,183,228,164,147,245,254,213,119,19,234,158,170,81,111,86,52,50,140,196,227,103,183,177,78,243,252,243,104,177,220,15,138,115,179,17,137,182,222,228,13,90,236,71,197,1,193,115,18,250,232,229,19,27,133,54,186,184,106,193,164,87,35,233,27,22,161,36,89,10,96,92,141,183,78,68,179,136,5,88,245,171,209,111,192,62,131,193,29,10,205,86,121,198,40,147,142,123,126,81,194,89,128,26,252,23,150,109,62,142,120,48,31,150,36,162,161,128,232,58,51,16,231,48,152,193,137,35,96,248,87,97,87,125,170,29,242,173,101,5,250,1,156,101,202,58,100,146,190,92,89,210,174,40,130,40,162,122,202,228,192,197,52,246,95,151,9,14,208,190,42,113,127,60,119,176,155,119,12,203,124,26,5,158,227,51,156,149,13,236,122,11,48,35,184,81,56,220,56,7,63,131,112,158,229,20,255,150,114,19,64,103,88,141,127,10,149,218,230,52,119,223,113,132,104,147,241,160,135,7,192,193,72,14,240,111,49,189,140,102,104,160,61,35,8,157,28,100,99,139,38,124,195,136,156,8,81,88,26,148,80,77,90,206,165,178,175,255,202,233,152,106,34,30,112,56,174,126,206,214,63,105,28,35,61,165,77,199,78,105,91,177,119,187,169,209,1,223,214,111,34,40,34,44,71,164,65,250,15,124,142,44,33,182,7,146,47,237,151,37,34,156,208,87,228,117,252,188,238,231,140,214,148,238,217,53,10,145,54,111,116,146,87,16,132,152,120,157,77,187,138,193,176,51,187,53,246,43,116,8,248,45,80,202,170,18,204,230,60,255,114,22,164,57,20,150,49,71,232,58,30,223,21,51,184,223,118,117,236,171,241,79,186,228,0,231,233,221,118,232,73,192,177,187,239,59,51,234,75,140,2,150,60,186,112,147,204,92,44,107,62,194,202,90,96,55,3,255,3,241,128,77,124,182,252,54,137,9,4,190,17,64,79,244,123,236,212,182,186,91,187,183,152,161,229,85,46,49,52,141,62,119,212,171,71,180,5,243,88,147,129,134,91,243,48,224,48,113,30,14,163,195,5,176,239,107,219,33,54,67,33,219,101,155,180,150,81,81,12,33,191,45,202,80,76,181,110,155,157,53,58,152,128,75,129,244,217,167,213,112,47,74,208,90,178,74,99,68,3,113,141,37,38,97,228,219,235,207,28,24,214,231,85,128,184,169,230,24,76,31,80,85,30,186,217,171,117,221,54,187,99,223,155,196,189,148,53,174,190,191,178,192,36,77,203,188,188,30,255,249,137,203,84,140,227,9,234,38,23,90,207,195,233,90,196,207,196,58,205,221,93,144,71,11,79,214,14,141,196,231,212,9,212,35,92,8,53,234,82,53,211,99,187,169,17,66,47,131,53,120,152,89,105,17,24,36,51,115,219,28,194,212,108,118,242,216,39,29,200,244,15,251,190,71,187,236,16,195,59,210,138,130,185,233,236,161,25,252,8,163,60,48,230,98,2,189,192,194,55,160,85,5,251,54,23,41,212,105,242,114,247,197,92,170,14,127,173,190,18,58,65,16,189,48,5,0,72,226,45,32,172,47,235,146,20,41,27,123,63,187,62,181,58,164,44,214,38,173,78,38,135,40,244,22,185,23,116,220,128,84,249,18,225,1,177,99,245,208,139,43,236,183,201,203,62,48,88,75,174,30,95,77,37,20,134,20,192,105,140,28,103,108,175,178,87,135,205,17,251,70,221,127,185,163,142,55,132,2,106,112,166,221,137,156,9,21,157,196,13,128,78,198,222,116,174,239,41,120,22,167,242,222,188,93,108,74,124,194,137,102,97,241,169,60,185,245,40,112,21,91,226,199,174,232,173,88,0,199,188,8,50,194,25,69,91,111,161,10,152,211,14,35,21,128,238,161,233,217,171,66,196,4,216,176,30,9,69,19,45,216,188,17,19,237,114,138,254,132,54,85,183,236,104,70,123,189,140,32,131,19,122,8,69,22,139,218,152,205,60,152,44,132,7,73,155,144,115,63,230,127,148,131,32,185,232,108,79,66,47,248,168,124,13,155,209,130,89,131,174,239,230,176,23,121,64,0,8,232,0,35,34,103,132,139,176,49,38,24,186,50,196,252,36,150,88,181,224,185,19,94,97,180,183,152,179,99,100,96,133,183,141,113,157,232,243,244,5,230,144,26,106,237,96,113,113,204,202,166,214,178,101,79,150,164,156,64,112,14,248,217,120,159,25,125,155,195,53,113,63,229,13,128,166,221,93,14,56,216,41,121,140,143,13,113,206,135,178,203,135,164,178,162,193,198,146,131,151,247,182,218,124,37,43,249,13,8,21,208,68,146,2,37,71,205,25,150,193,136,58,164,3,238,41,80,163,37,56,35,201,165,69,28,47,184,24,64,139,15,165,87,33,146,112,136,193,75,133,147,144,55,61,98,149,138,145,82,111,130,3,92,84,103,13,186,97,235,179,152,44,200,23,253,32,91,118,63,46,191,70,86,239,191,132,234,14,188,16,163,154,122,53,141,172,6,158,234,164,86,147,22,70,226,205,96,188,198,249,25,80,98,78,74,1,241,15,48,125,23,212,155,255,157,176,213,6,150,242,95,229,67,84,127,250,88,117,255,13,93,136,243,215,112,33,162,136,198,39,156,115,179,22,242,129,148,180,204,103,140,236,29,149,12,21,102,18,102,153,213,80,209,89,81,28,171,27,117,64,195,233,164,255,156,118,32,83,147,111,140,24,84,59,235,192,62,203,216,62,225,206,30,169,3,247,158,101,213,234,127,89,243,122,84,74,123,239,185,251,68,69,174,179,86,150,157,37,7,88,65,243,212,161,133,180,137,13,73,208,41,34,45,111,0,5,228,0,0,3,0,0,3,0,93,224,67,16,10,146,0,0,3,0,26,32,0,0,21,16])},o={codec:"avc1.64001e",width:516,height:360,description:new Uint8Array([1,100,0,30,255,225,0,31,103,100,0,30,172,217,64,132,47,231,151,255,0,135,1,88,16,0,0,3,0,16,0,0,3,3,192,241,98,217,96,1,0,6,104,235,224,228,178,44]),sps:new Uint8Array([103,100,0,30,172,217,64,132,47,231,151,255,0,135,1,88,16,0,0,3,0,16,0,0,3,3,192,241,98,217,96]),pps:new Uint8Array([104,235,224,228,178,44]),keyframe:new Uint8Array([101,136,132,0,47,255,253,24,239,2,147,111,109,7,9,180,129,11,31,217,50,170,153,204,64,0,0,3,0,0,8,73,68,141,201,128,158,94,192,0,0,151,0,35,68,44,183,5,224,191,20,251,227,212,192,9,62,164,128,113,86,137,39,255,107,152,247,10,118,194,99,232,207,128,164,10,3,71,135,40,61,96,221,141,97,82,217,89,170,95,144,132,191,1,32,62,200,75,210,249,98,217,154,178,158,202,9,195,240,188,32,177,177,215,30,105,172,33,113,184,124,88,128,41,76,213,198,48,125,146,108,198,177,146,7,177,118,223,126,197,157,170,98,175,209,117,165,80,97,62,171,53,223,5,72,148,1,207,143,253,89,253,90,239,203,175,3,233,77,83,186,62,109,145,117,129,136,0,129,138,157,252,229,162,61,142,41,30,231,224,241,10,155,128,182,112,3,19,188,155,156,213,216,48,217,82,247,202,135,249,87,142,84,99,187,61,124,153,200,20,85,63,255,39,235,91,85,123,91,54,183,100,114,180,234,166,159,25,35,219,234,6,10,211,127,177,25,66,0,65,186,150,203,151,135,29,178,63,135,139,244,213,195,224,23,167,158,181,180,86,84,160,239,29,229,61,58,11,104,32,166,61,219,216,252,196,130,177,118,175,222,234,238,200,106,99,211,104,148,241,139,101,145,135,100,108,148,144,186,33,243,211,228,88,112,16,107,201,113,200,94,216,125,239,143,79,69,214,157,124,213,237,75,44,82,27,69,123,245,176,27,77,107,59,173,169,224,70,3,1,119,220,55,251,103,161,146,23,5,51,244,125,26,65,233,112,209,177,185,36,92,167,151,137,244,97,238,49,19,165,156,152,157,166,215,130,79,31,109,252,15,116,175,116,169,213,207,133,136,232,216,210,95,227,207,46,179,88,159,69,9,239,116,119,166,17,173,170,103,184,88,82,184,148,67,128,214,155,225,103,155,176,71,188,116,76,153,223,74,194,121,172,172,238,24,3,138,63,107,158,122,118,231,76,95,155,64,216,123,214,228,114,58,205,90,202,249,235,31,11,85,77,183,196,118,224,242,110,170,78,149,62,229,132,161,153,42,94,173,179,21,191,151,4,73,243,90,165,166,201,7,139,5,100,34,200,98,188,198,43,152,136,193,104,38,52,20,51,222,238,121,68,241,62,94,217,147,222,156,235,251,39,254,210,91,102,204,170,114,161,113,172,103,105,16,82,247,239,84,2,141,252,104,9,117,44,97,241,224,186,43,251,57,96,228,95,13,203,216,41,130,155,133,136,64,53,26,211,91,206,140,23,114,9,31,137,86,250,50,185,148,192,124,216,198,132,45,53,52,250,238,200,0,191,105,123,56,139,8,100,140,34,122,177,7,215,21,239,194,14,4,73,138,200,1,2,177,6,81,135,117,100,95,189,251,53,241,145,135,101,160,136,48,101,143,144,113,148,196,57,3,203,1,148,84,238,151,135,169,187,150,247,97,202,214,23,40,20,4,210,105,115,238,14,146,65,46,118,152,36,23,239,23,143,203,11,65,253,0,55,25,13,194,243,56,0,207,99,246,106,156,177,222,202,198,232,220,93,50,40,144,151,45,254,63,144,194,211,151,210,120,86,58,152,94,137,143,41,235,0,88,20,132,106,125,224,178,156,237,149,130,11,33,10,114,120,239,94,111,80,100,128,6,89,75,149,105,123,51,61,58,106,193,99,134,242,161,10,27,109,185,245,177,107,75,78,210,157,79,227,99,138,248,158,3,164,36,157,118,31,69,52,63,104,98,179,20,126,75,200,189,168,236,162,93,111,187,188,69,115,242,100,196,54,228,63,207,143,249,171,23,240,12,181,93,130,186,183,163,24,63,202,182,160,194,109,171,76,221,23,125,131,210,109,170,192,51,37,104,16,252,218,153,64,13,36,218,134,83,27,40,27,195,85,8,78,241,38,110,61,66,221,117,166,216,243,77,187,113,188,220,135,65,50,248,42,195,1,14,209,230,18,172,214,162,164,131,156,139,183,228,249,46,133,62,210,5,20,24,148,248,134,158,152,149,61,107,39,144,7,112,229,43,84,127,32,203,200,39,240,31,62,80,31,129,198,219,110,61,93,128,70,228,244,238,71,184,43,141,51,83,247,32,88,247,94,18,166,3,86,111,185,13,141,236,208,71,249,112,232,205,196,114,222,30,62,236,183,162,202,255,207,36,159,39,251,72,59,201,171,230,13,105,190,98,85,254,168,135,125,103,12,221,90,3,193,254,64,46,166,220,72,220,202,101,150,71,212,18,20,71,243,43,248,103,45,186,235,133,209,36,196,76,134,67,69,165,227,63,151,240,181,182,57,244,119,5,131,34,50,114,71,148,176,81,235,4,56,119,33,154,204,53,125,163,131,151,99,86,70,31,203,215,191,96,92,144,231,139,15,108,100,185,232,113,205,135,236,8,75,214,124,224,0,0,252,56,192,146,213,219,29,234,156,228,103,93,190,39,109,92,106,221,233,228,49,75,203,98,177,32,233,57,95,221,153,97,62,226,188,240,254,42,228,7,22,180,92,51,131,52,247,190,145,183,33,92,18,11,30,191,183,76,85,14,95,162,35,166,156,250,229,250,138,77,208,96,225,69,26,79,16,82,221,83,195,132,81,122,56,15,212,194,249,196,58,254,121,134,122,120,33,164,6,93,141,216,219,236,121,85,6,4,45,62,209,32,117,240,110,72,235,2,240,70,149,227,213,235,18,5,202,77,99,188,189,179,21,222,41,65,95,182,157,219,44,112,136,180,102,88,15,250,7,95,241,43,198,81,131,244,0,0,3,2,195,179,68,87,56,11,166,25,115,105,216,143,3,252,45,41,38,33,191,216,118,246,171,196,168,80,134,3,8,55,151,21,233,173,238,251,248,114,53,166,95,226,49,198,193,47,165,145,87,9,253,111,111,149,240,217,42,253,64,81,112,182,90,54,243,20,47,146,71,40,222,249,167,212,13,33,95,17,128,133,137,232,172,0,35,121,226,39,87,122,91,236,107,8,44,246,228,66,7,120,67,148,44,15,55,104,198,21,210,190,219,217,239,148,40,10,208,139,200,204,103,110,203,71,103,59,91,116,123,5,109,152,38,151,82,107,157,51,51,163,215,174,111,163,78,240,213,35,155,114,47,109,126,103,168,158,142,31,145,219,162,131,77,168,34,154,226,119,84,116,172,107,241,27,197,200,243,0,13,26,62,129,193,240,54,99,253,52,179,182,157,197,18,208,5,65,167,173,239,32,205,246,195,67,74,127,23,145,82,234,150,140,74,202,239,62,149,204,138,117,85,236,88,128,2,205,207,47,175,89,153,163,64,241,192,225,214,208,153,107,50,177,235,29,5,83,101,106,183,60,210,229,89,202,214,177,114,241,219,188,229,1,52,109,70,212,35,208,66,168,26,76,113,100,161,54,82,92,79,117,171,22,108,138,111,24,243,12,103,221,247,103,211,44,52,63,148,22,2,210,200,97,243,251,90,27,32,33,169,171,79,3,154,206,5,89,90,9,223,243,125,39,33,170,188,180,248,196,219,78,202,161,83,132,36,172,149,79,119,107,192,36,123,82,1,218,27,185,233,82,210,205,60,26,35,181,67,163,44,0,0,3,0,0,3,0,29,145])};function n(e){let t;const i=new Promise(((e,i)=>{t=e})),a=performance.now(),r=new VideoDecoder({output:e=>{e.close(),t({support:!0,cost:performance.now()-a})},error:e=>{t({support:!1,cost:performance.now()-a})}}),o={codec:e.codec,codedWidth:e.width,codedHeight:e.height,description:e.description},n=[e.vps,e.pps,e.pps,e.keyframe];return VideoDecoder.isConfigSupported(o).then((()=>r.configure(o))).then((()=>{const e=new EncodedVideoChunk({type:"key",data:s(n),timestamp:0,duration:4e4});return r.decode(e),r.flush().then((()=>{r.close()}))})).catch((()=>{t({support:!1,cost:performance.now()-a})})),i}const l={isSupportedH265:function(){return a()?n(r):Promise.reject({support:!1,cost:0})},isSupportedH264:function(){return a()?n(o):Promise.reject({support:!1,cost:0})}}},96077:(e,t,i)=>{i.r(t),i.d(t,{FlvPlugin:()=>F,VEErrorCode:()=>g,default:()=>L});var s=i(26024),a=i(33481),r=Object.defineProperty,o=(e,t,i)=>((e,t,i)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i);function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var l={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,i="~";function s(){}function a(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function r(e,t,s,r,o){if("function"!=typeof s)throw new TypeError("The listener must be a function");var n=new a(s,r||e,o),l=i?i+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],n]:e._events[l].push(n):(e._events[l]=n,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function n(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(i=!1)),n.prototype.eventNames=function(){var e,s,a=[];if(0===this._eventsCount)return a;for(s in e=this._events)t.call(e,s)&&a.push(i?s.slice(1):s);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(e)):a},n.prototype.listeners=function(e){var t=i?i+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var a=0,r=s.length,o=new Array(r);a<r;a++)o[a]=s[a].fn;return o},n.prototype.listenerCount=function(e){var t=i?i+e:e,s=this._events[t];return s?s.fn?1:s.length:0},n.prototype.emit=function(e,t,s,a,r,o){var n=i?i+e:e;if(!this._events[n])return!1;var l,h,d=this._events[n],c=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),c){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,s),!0;case 4:return d.fn.call(d.context,t,s,a),!0;case 5:return d.fn.call(d.context,t,s,a,r),!0;case 6:return d.fn.call(d.context,t,s,a,r,o),!0}for(h=1,l=new Array(c-1);h<c;h++)l[h-1]=arguments[h];d.fn.apply(d.context,l)}else{var _,g=d.length;for(h=0;h<g;h++)switch(d[h].once&&this.removeListener(e,d[h].fn,void 0,!0),c){case 1:d[h].fn.call(d[h].context);break;case 2:d[h].fn.call(d[h].context,t);break;case 3:d[h].fn.call(d[h].context,t,s);break;case 4:d[h].fn.call(d[h].context,t,s,a);break;default:if(!l)for(_=1,l=new Array(c-1);_<c;_++)l[_-1]=arguments[_];d[h].fn.apply(d[h].context,l)}}return!0},n.prototype.on=function(e,t,i){return r(this,e,t,i,!1)},n.prototype.once=function(e,t,i){return r(this,e,t,i,!0)},n.prototype.removeListener=function(e,t,s,a){var r=i?i+e:e;if(!this._events[r])return this;if(!t)return o(this,r),this;var n=this._events[r];if(n.fn)n.fn===t&&(!a||n.once)&&(!s||n.context===s)&&o(this,r);else{for(var l=0,h=[],d=n.length;l<d;l++)(n[l].fn!==t||a&&!n[l].once||s&&n[l].context!==s)&&h.push(n[l]);h.length?this._events[r]=1===h.length?h[0]:h:o(this,r)}return this},n.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&o(this,t)):(this._events=new s,this._eventsCount=0),this},n.prototype.off=n.prototype.removeListener,n.prototype.addListener=n.prototype.on,n.prefixed=i,n.EventEmitter=n,e.exports=n}(l);const h=n(l.exports);var d=(e=>(e.PROTOCOL_CONFIG="up_protocolconfig",e.MEDIACODEC_CONFIG="up_veconfig",e.LOAD_STREAM="up_loadstream",e.SEAMLESS_LOAD_STREAM="up_seamlessloadstream",e.CANCEL_SWITCH="up_cancelswitch",e.PLAY="up_play",e.PAUSE="up_pause",e.PAUSE_EVENT="up_pause_event",e.MUTED_SET="up_mutedset",e.CURRENT_TIME="up_currenttime",e.PLAYBACKRATE="up_playbackrate",e.WRITABLE="up_writable",e.ERROR="up_error",e.DESTROY="up_destroy",e.INIT="up_init",e.MESSAGE_DURATION="down_duration",e.MESSAGE_CURRENT_TIME="down_currenttime",e.MESSAGE_EVENT_PLAYEND="down_playend",e.MESSAGE_BUFFERED="down_buffered",e.MESSAGE_PLAYBACKRATE="down_playbackrate",e.MESSAGE_INIT_RENDER="down_initrender",e.MESSAGE_FIRSTFRAME="down_firstframe",e.MESSAGE_SWITCH_SUCCESS="down_switchsuccess",e.MESSAGE_LOUDNESS_BALANCE="down_loudness_balance",e.MESSAGE_SEI_LOUDNESS="down_sei_loudness",e.MESSAGE_EVENT_VEERROR="down_e_veerror",e.MESSAGE_EVENT_SEEKING="down_e_seeking",e.MESSAGE_EVENT_WAITING="down_e_waiting",e.MESSAGE_EVENT_SEEKED="down_e_seeked",e.MESSAGE_EVENT_CANPLAY="down_e_canplay",e.MESSAGE_EVENT_PLAYING="down_e_playing",e.MESSAGE_EVENT_TIMEUPDATE="down_e_timeupdate",e.MESSAGE_CATCH_AUDIOCTX_ERROR="catch_audioctx_error",e))(d||{});const c=1e6;var _=(e=>(e.NETWORK="network",e.DEMUX="demux",e.DECODE="decode",e.VEWORKER="veworker",e.RENDER="render",e))(_||{}),g=(e=>(e[e.MOCK_ERROR=2e4]="MOCK_ERROR",e[e.DECODE_VIDEO_INIT_ERROR=3e4]="DECODE_VIDEO_INIT_ERROR",e[e.DECODE_AUDIO_INIT_ERROR=30001]="DECODE_AUDIO_INIT_ERROR",e[e.DECODE_VIDEO_OUTPUT_ERROR=30002]="DECODE_VIDEO_OUTPUT_ERROR",e[e.DECODE_AUDIO_OUTPUT_ERROR=30003]="DECODE_AUDIO_OUTPUT_ERROR",e[e.DECODE_VIDEO_DODECODE_ERROR=30004]="DECODE_VIDEO_DODECODE_ERROR",e[e.DECODE_AUDIO_DODECODE_ERROR=30005]="DECODE_AUDIO_DODECODE_ERROR",e[e.DECODE_VIDEO_LONGTIME_NO_OUTPUT=30006]="DECODE_VIDEO_LONGTIME_NO_OUTPUT",e[e.VEWORKER_RUNTIME_ERROR=4e4]="VEWORKER_RUNTIME_ERROR",e[e.VEWORKER_INIT_ERROR=40001]="VEWORKER_INIT_ERROR",e[e.VEWORKER_URL_ERROR=40002]="VEWORKER_URL_ERROR",e[e.VEWORKER_POSTMESSAGE_ERROR=40003]="VEWORKER_POSTMESSAGE_ERROR",e[e.RENDER_WORKLET_INIT_ERROR=5e4]="RENDER_WORKLET_INIT_ERROR",e[e.RENDER_WORKLET_RUNTIME_ERROR=50001]="RENDER_WORKLET_RUNTIME_ERROR",e[e.RENDER_VIDEOTRACK_INIT_ERROR=50002]="RENDER_VIDEOTRACK_INIT_ERROR",e[e.RENDER_AUDIOCTX_ERROR=50003]="RENDER_AUDIOCTX_ERROR",e))(g||{});class p extends Error{constructor(e,t,i,s){super((null==i?void 0:i.message)||s),o(this,"eType"),o(this,"code"),this.eType=e,this.code=g[t]}static create(e,t,i,s){return new p(e,t,i,s)}static isFatalError(e,t){if(4e4===e||40001===e||40002===e||5e4===e||50003===e||-1!==t.indexOf("Unsupported configuration")||-1!==t.indexOf("key frame is required")||-1!==t.indexOf("Decoder error"))return!0}static isDecodingError(e){return 2e4===e.code||(30002===e.code||30003===e.code)&&"Decoding error."===e.message}}function u(){}const m=class e{constructor(t){return o(this,"_moduleName"),o(this,"log"),o(this,"info"),o(this,"warn"),o(this,"error"),o(this,"debug"),o(this,"table"),o(this,"trace"),o(this,"group"),o(this,"groupEnd"),this._moduleName=t,new Proxy(this,{get:(t,i)=>e.enable?console[i].bind(console,`[${this._moduleName}]`):u})}static setEnable(t){e.enable=t}};o(m,"enable",!1);let y=m,f=!1;try{f=!!localStorage.getItem("xgcodec")}catch{}function E(){return f}const C=new y("WorkerPool"),I=class{};o(I,"pool",[]),o(I,"workerUrl"),o(I,"setWorkerUrl",(e=>{I.workerUrl=e,C.log("set worker url:",e)})),o(I,"cache",(e=>{I.pool.push(e),C.log(`cache worker instance, total:${I.pool.length}`)})),o(I,"getItem",(()=>{if(!I.pool.length){if(I.workerUrl)return new Worker(I.workerUrl);throw new Error("no worker url found")}const e=I.pool.shift();return null==e||e.postMessage({type:d.INIT}),C.warn(`use cached worker, remain count: ${I.pool.length}`),e}));let A=I;class v extends h{constructor(e){super(),o(this,"logger",new y("Main")),o(this,"_workerSink"),o(this,"_media",null),o(this,"_audioTrack",null),o(this,"_videoTrack",null),o(this,"_onWorkerMessage",(e=>{this.emit(e.data.type,e.data)})),o(this,"_onWorkerError",(e=>{var t;e.message?this.onVEError(p.create(_.VEWORKER,"VEWORKER_RUNTIME_ERROR",e)):this.onVEError(p.create(_.VEWORKER,"VEWORKER_URL_ERROR",e));try{null==(t=this._workerSink)||t.terminate(),this._workerSink=null}catch{}})),this._media=e.media;try{A.setWorkerUrl(e.workerUrl),this._workerSink=A.getItem()}catch(e){this._workerSink=null,setTimeout((()=>{this.onVEError(p.create(_.VEWORKER,"VEWORKER_INIT_ERROR",e))}))}this._bindInteractionEvent(),this._enableLog(),this.logger.log("init ve worker!",`[${performance.now()}]`)}_bindInteractionEvent(){var e,t;null==(e=this._workerSink)||e.addEventListener("message",this._onWorkerMessage),null==(t=this._workerSink)||t.addEventListener("error",this._onWorkerError),this._transEventUp(d.PROTOCOL_CONFIG),this._transEventUp(d.MEDIACODEC_CONFIG),this._transEventUp(d.LOAD_STREAM),this._transEventUp(d.SEAMLESS_LOAD_STREAM),this._transEventUp(d.CANCEL_SWITCH),this._transEventUp(d.PLAY),this._transEventUp(d.PAUSE),this._transEventUp(d.PAUSE_EVENT),this._transEventUp(d.MUTED_SET),this._transEventUp(d.PLAYBACKRATE),this._transEventUp(d.CURRENT_TIME),this._transEventUp(d.ERROR),this._transEventUp(d.DESTROY),this._transWritableComponentUp(),this.on(d.MESSAGE_INIT_RENDER,this.onInitRender),this.on(d.MESSAGE_DURATION,this.onDuration),this.on(d.MESSAGE_CURRENT_TIME,this.onCurrentTime),this.on(d.MESSAGE_BUFFERED,this.onBufferUpdate),this.on(d.MESSAGE_EVENT_PLAYEND,this.onPlayEnd),this.on(d.MESSAGE_PLAYBACKRATE,this.onPlaybackRate),this.on(d.MESSAGE_FIRSTFRAME,this.onFirstFrame),this.on(d.MESSAGE_SWITCH_SUCCESS,this.onSwitchSuccess),this.on(d.MESSAGE_LOUDNESS_BALANCE,this.onLoudnessBalance),this.on(d.MESSAGE_SEI_LOUDNESS,this.onSEILoudness),this.on(d.MESSAGE_EVENT_VEERROR,this.onVEError),this.on(d.MESSAGE_EVENT_WAITING,(()=>{this.logger.log("waiting!"),this.dispatchEvent("waiting")})),this.on(d.MESSAGE_EVENT_SEEKING,(()=>this.dispatchEvent("seeking"))),this.on(d.MESSAGE_EVENT_SEEKED,(()=>this.dispatchEvent("seeked"))),this.on(d.MESSAGE_EVENT_CANPLAY,(()=>this.dispatchEvent("canplay"))),this.on(d.MESSAGE_EVENT_PLAYING,(()=>this.dispatchEvent("playing")))}_transEventUp(e){this.on(e,(t=>{var i;try{null==(i=this._workerSink)||i.postMessage({type:e,...t})}catch(e){this.onVEError(p.create(_.VEWORKER,"VEWORKER_POSTMESSAGE_ERROR",e))}}))}_transWritableComponentUp(){this.on(d.WRITABLE,(e=>{var t;try{null==(t=this._workerSink)||t.postMessage({type:d.WRITABLE,...e},[null==e?void 0:e.videoWritable,null==e?void 0:e.audioWritable].filter(Boolean))}catch(e){this.onVEError(p.create(_.VEWORKER,"VEWORKER_POSTMESSAGE_ERROR",e))}}))}_enableLog(){E()&&(y.setEnable(!0),this.emit(d.MEDIACODEC_CONFIG,{enableLogger:1}))}_cacheWorkerIns(){this._workerSink&&(this.emit(d.DESTROY),this.removeAllListeners(),this._workerSink.removeEventListener("message",this._onWorkerMessage),this._workerSink.removeEventListener("error",this._onWorkerError),A.cache(this._workerSink),this._workerSink=null)}destroy(){this._cacheWorkerIns(),this.closeRender()}closeRender(){var e,t;this._audioTrack&&(null==(t=(e=this._audioTrack).disconnect)||t.call(e),this._audioTrack.disconnect=void 0),this._audioTrack=null,this._videoTrack=null}dispatchEvent(e,t){var i;null==(i=this._media)||i.dispatchEvent(new CustomEvent(e,t))}async onInitRender(e){}onDuration(e){}onCurrentTime(e){}onBufferUpdate(e){}onPlaybackRate(e){}onFirstFrame(e){}onSwitchSuccess(e){}onLoudnessBalance(e){}onSEILoudness(e){}onPlayEnd(){}onVEError(e){}}o(v,"WorkerPool",A);let R=!1;function b(){if(R)return R;const e=new AudioContext,t="running"===e.state;return e.suspend().catch((()=>{})),e.close().catch((()=>{})),R=t,t}const S=class{};o(S,"pool",[]),o(S,"cache",(e=>{S.pool.push(e)})),o(S,"getItem",((e,t)=>{S.pool=S.pool.filter((e=>"closed"!==e.ctx.state));const i=S.pool.findIndex((i=>i.sampleRate===e&&i.heAAC===t));return-1===i?null:S.pool.splice(i,1)[0].ctx}));let T=S;const w=new y("AudioGenerate");function O(e,t,i){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var P,D={MANIFEST:"manifest",NETWORK:"network",NETWORK_TIMEOUT:"network_timeout",NETWORK_FORBIDDEN:"network_forbidden",NETWORK_NOTFOUND:"network_notfound",NETWROK_RANGE_NOT_SATISFIABLE:"network_range_not_satisfiable",DEMUX:"demux",REMUX:"remux",MEDIA:"media",DRM:"drm",OTHER:"other",RUNTIME:"runtime",SUB_TYPES:{FLV:"FLV",HLS:"HLS",MP4:"MP4",FMP4:"FMP4",MSE_ADD_SB:"MSE_ADD_SB",MSE_APPEND_BUFFER:"MSE_APPEND_BUFFER",MSE_OTHER:"MSE_OTHER",MSE_FULL:"MSE_FULL",MSE_CHANGE_TYPE:"MSE_CHANGE_TYPE",OPTION:"OPTION",DASH:"DASH",LICENSE:"LICENSE",CUSTOM_LICENSE:"CUSTOM_LICENSE",MSE_HIJACK:"MSE_HIJACK",EME_HIJACK:"EME_HIJACK",SIDX:"SIDX",NO_CANPLAY_ERROR:"NO_CANPLAY_ERROR",BUFFERBREAK_ERROR:"BUFFERBREAK_ERROR",WAITING_TIMEOUT_ERROR:"WAITING_TIMEOUT_ERROR",MEDIA_ERR_ABORTED:"MEDIA_ERR_ABORTED",MEDIA_ERR_NETWORK:"MEDIA_ERR_NETWORK",MEDIA_ERR_DECODE:"MEDIA_ERR_DECODE",MEDIA_ERR_SRC_NOT_SUPPORTED:"MEDIA_ERR_SRC_NOT_SUPPORTED",MEDIA_ERR_CODEC_NOT_SUPPORTED:"MEDIA_ERR_CODEC_NOT_SUPPORTED",MEDIA_ERR_URL_EMPTY:"MEDIA_ERR_URL_EMPTY"}},W=(O(O(O(O(O(O(O(O(O(O(P={},D.MANIFEST,{HLS:1100,DASH:1200}),D.NETWORK,2100),D.NETWORK_TIMEOUT,2101),D.NETWORK_FORBIDDEN,2103),D.NETWORK_NOTFOUND,2104),D.NETWROK_RANGE_NOT_SATISFIABLE,2116),D.DEMUX,{FLV:3100,HLS:3200,MP4:3300,FMP4:3400,SIDX:3410}),D.REMUX,{FMP4:4100,MP4:4200}),D.MEDIA,{MEDIA_ERR_ABORTED:5101,MEDIA_ERR_NETWORK:5102,MEDIA_ERR_DECODE:5103,MEDIA_ERR_SRC_NOT_SUPPORTED:5104,MEDIA_ERR_CODEC_NOT_SUPPORTED:5105,MEDIA_ERR_URL_EMPTY:5106,MSE_ADD_SB:5200,MSE_APPEND_BUFFER:5201,MSE_OTHER:5202,MSE_FULL:5203,MSE_HIJACK:5204,MSE_CHANGE_TYPE:5205,EME_HIJACK:5301}),D.DRM,{LICENSE:7100,CUSTOM_LICENSE:7200}),O(O(P,D.OTHER,8e3),D.RUNTIME,{NO_CANPLAY_ERROR:9001,BUFFERBREAK_ERROR:9002,WAITING_TIMEOUT_ERROR:9003})),G=(e=>(e.FLVERROR="flverror",e.LOADRETRY="retry",e.TTFB="ttfb",e.RESPONSEHEADERS="responseheaders",e.METADATA="metadataparsed",e.KEYFRAME="isKeyframe",e.SEI="SEI_PARSED",e.SEI_LOUDNESS="SEI_LOUDNESS",e.CHASE_FRAME="chaseframe",e.STREAM_EXCEPTION="streamexception",e.SWITCH_START="switch_start",e.SWITCH_COMPLETE="switch_completed",e.SWITCH_ERROR="switch_error",e.PROP_SPEED="flv_prop_speed",e.PROP_ENDEDSTATUS="flv_prop_endedstatus",e.LOUDNESS_BALANCE_START="loudness_balance_start",e))(G||{});function k(e){return e.httpCode?e.httpCode:e.code===W[D.NETWORK]?21:e.code===W[D.NETWORK_TIMEOUT]?999:e.code===W[D.DEMUX].FLV?31:0}function V(e){return{code:k(e),errorType:e.errorType,type:e.errorType,ex:e.message,url:e.url}}class M{constructor(){o(this,"length",0),o(this,"_videoBufferEnd",0),o(this,"_audioBufferEnd",0)}start(e){if(e>this.length-1)throw new Error(`Failed to execute 'start' on 'TimeRanges': The index provided (${e}) is greater than the maximum bound (${this.length})`);return 0}end(e){if(e>this.length-1)throw new Error(`Failed to execute 'end' on 'TimeRanges': The index provided (${e}) is greater than the maximum bound (${this.length})`);return Math.min(this._audioBufferEnd,this._videoBufferEnd)}update(e){this.length||(this.length=1),this._videoBufferEnd=e.videoBufferEnd/c,this._audioBufferEnd=e.audioBufferEnd/c}}class L extends v{constructor(e){super(e),o(this,"_opts"),o(this,"_currentTime",0),o(this,"_playbackRate",1),o(this,"_duration",1/0),o(this,"_srcUrl",""),o(this,"_errorInfo",null),o(this,"_revocable",null),o(this,"_proxyMedia",null),o(this,"_buffered",new M),o(this,"_repaceMediaTrack",!1),o(this,"_startTime",0),o(this,"_firstframeCost",{}),o(this,"_firstTimeLoad",!0),o(this,"_manualMute",!1),o(this,"_tabHiddenHandle",0),o(this,"_retryCountForDecodeError",1),o(this,"_firstLoudness",null),o(this,"onAudioCtxError",(()=>{var e,t;if("suspended"===(null==(t=null==(e=this._audioTrack)?void 0:e.ctx)?void 0:t.state))return;const i=new Error("The AudioContext encountered an error from the audio device or the WebAudio renderer");this.onVEError(p.create(_.RENDER,"RENDER_AUDIOCTX_ERROR",i))})),o(this,"_onMediaPlay",(()=>{var e,t,i,s;this.logger.warn("on play event! message to worker");const a=null==(t=null==(e=this._media)?void 0:e.srcObject)?void 0:t.getTracks();this._media&&!(null!=a&&a.length)&&(this._media.srcObject=new MediaStream),this._media&&(this.emit(d.MUTED_SET,{muted:this._media.muted,autoplayPolicy:b()}),this.emit(d.PLAY),"suspended"===this.audioCtxState&&(null==(s=null==(i=this._audioTrack)?void 0:i.ctx.resume())||s.then((()=>{var e,t;this.logger.log("audio context resumed!"),null!=(e=this.media)&&e.paused&&(this.logger.log("but media paused, suspend audiocontext!"),null==(t=this._audioTrack)||t.ctx.suspend().catch((e=>{})))}))))})),o(this,"_onMediaPause",(()=>{var e,t;this.isMutedStart&&this._tabHiddenHandle||(this.logger.log("on pause event!"),this.emit(d.PAUSE_EVENT,{}),null==(t=null==(e=this._audioTrack)?void 0:e.ctx.suspend())||t.then((()=>{this.logger.log("audio context suspend!")})))})),o(this,"_onOnceCanplay",(()=>{this._media&&(this._media.removeEventListener("canplay",this._onOnceCanplay),this._firstTimeLoad&&!this._media.autoplay&&(this.logger.log("hack, 展示首帧! call play()"),this._media.autoplay=!0,this._media.play().finally((()=>{var e;this.logger.log("call pause()"),null==(e=this._media)||e.pause(),this.emit(d.PAUSE)}))),this._firstTimeLoad=!1)})),o(this,"_onMediaVolumeChange",(()=>{var e;const t=b();this.logger.log("volume change"),this._media&&(this.emit(d.MUTED_SET,{muted:this._media.muted,autoplayPolicy:t}),"suspended"===this.audioCtxState&&t&&(null==(e=this._audioTrack)||e.ctx.resume()))})),o(this,"_onMediaLoadeddata",(()=>{this._media&&(this._media.removeEventListener("loadeddata",this._onMediaLoadeddata),!this._media.muted&&!b()&&(this.logger.log("限制播放 && 非静音, 展示首帧, muted -> play() -> unmuted"),this._media.muted=!0,this._media.play().catch((e=>{})),this._media.muted=!1))})),o(this,"_visibilityChanged",(()=>{var e,t,i,s,a;try{"visible"===document.visibilityState&&this.isMutedStart&&this._tabHiddenHandle&&(this.logger.log("静音播放切回前台，重启播放"),this._tabHiddenHandle=0,null==(e=this._media)||e.play()),"hidden"===document.visibilityState&&this.isMutedStart&&(null==(t=this._media)||!t.paused)&&(this.logger.log("静音播放切到后台，暂停播放"),this._tabHiddenHandle=1,this.emit(d.PAUSE_EVENT,{disconnectBufferSize:360}),null==(s=null==(i=this._audioTrack)?void 0:i.ctx.suspend())||s.then((()=>{this.logger.log("audio context suspend!")})),null==(a=this._media)||a.pause())}catch{}})),this._opts=e,this._retryCountForDecodeError=e.retryCountForDecodeError,this._handlePlayPolicy()}get buffered(){return this._buffered}get media(){return this._media}get audioCtxState(){var e,t;return null==(t=null==(e=this._audioTrack)?void 0:e.ctx)?void 0:t.state}get isMutedStart(){var e;return!1===this._manualMute&&(null==(e=this._media)?void 0:e.muted)}adapt(){if(this._media&&!this._revocable)return this._revocable=Proxy.revocable(this._media,{set:(e,t,i)=>{if(this._media)return"src"===t?this._errorInfo&&p.isFatalError(this._errorInfo.subCode,this._errorInfo.message||"")&&i===this._srcUrl?(this.logger.log(`fatal error, subCode: ${this._errorInfo.subCode}, emit error agian `),this.dispatchEvent("error"),!0):(i!==this._srcUrl&&(this._firstLoudness=null),this._errorInfo=null,this._retryCountForDecodeError=this._opts.retryCountForDecodeError,this._startTime=performance.now(),this._media.srcObject=new MediaStream,this.logger.log("new srcObject for video"),this.closeRender(),this._srcUrl=i,this.logger.log(`start load stream: [${performance.now()}]`),this.emit(d.LOAD_STREAM,{url:i}),!0):"srcseamless"===t?(this._errorInfo=null,this._retryCountForDecodeError=this._opts.retryCountForDecodeError,this._startTime=performance.now(),this.logger.log("seamless load stream,",this._currentTime/c),this.emit(d.SEAMLESS_LOAD_STREAM,{url:i}),this.dispatchEvent("loadstart"),!0):"duration"===t?(this._duration=i,!0):"playbackRate"===t?(this.emit(d.PLAYBACKRATE,{rate:i}),!0):"currentTime"===t?(this._currentTime=i,this.emit(d.CURRENT_TIME,{time:i}),this.dispatchEvent("seeking"),!0):("muted"===t&&(this._manualMute=!0,this.logger.log("设置muted: ",i)),e[t]=i)},get:(e,t)=>"buffered"===t?this.buffered:"currentTime"===t?this._currentTime/c:"duration"===t?this._duration:"playbackRate"===t?this._playbackRate:"src"===t||"currentSrc"===t?this._srcUrl:"error"===t?this._errorInfo:"function"==typeof e[t]?("pause"===t&&(this.logger.warn("pause() called from outside!"),this.emit(d.PAUSE)),"play"===t&&this.logger.warn("play() called from outside!"),e[t].bind(this._media)):e[t]}),this._proxyMedia=this._revocable.proxy,this._proxyMedia&&(this._proxyMedia.getVersion=()=>"0.1.12-rc.0",this._proxyMedia.mockError=()=>{this.onVEError(p.create(_.VEWORKER,"MOCK_ERROR",new Error("mock error")))},this._proxyMedia.media=this._media),this._proxyMedia}reset(){var e,t,i;super.destroy(),this._unbindMediaEvent(),null==(e=this._revocable)||e.revoke(),this._removeOldTracks(null==(t=this._media)?void 0:t.srcObject),null!=(i=this._media)&&i.srcObject&&(this._media.srcObject=null),this._media=null,this._revocable=null,this.logger.log("revocable media proxy:",!!this._revocable)}updateProtoConfig(e){this.emit(d.PROTOCOL_CONFIG,e)}updateCodecConfig(e){this.emit(d.MEDIACODEC_CONFIG,e)}switchCancel(){this.emit(d.CANCEL_SWITCH)}getFirstframeCost(){return this._firstframeCost}async onInitRender(e){if(!this._media||this._errorInfo)return;this.logger.log("init render:",e,"autoplay:",this._media.autoplay);const t=b(),i=this._media.muted;let s,a;if(this._audioTrack&&this.closeRender(),this._firstLoudness&&(e.loudness=this._firstLoudness),e.audio)try{s=await async function(e,t,i){const{sampleRate:s,heAAC:a,channelCount:r,loudness:o}=e,n=a?2*s:s,l=T.getItem(s,a);let h=l||new AudioContext({sampleRate:n});l&&w.log(`reuse audiocontext for samplerate=${s}, heAAC=${a}`),h.addEventListener("error",i),h.suspend();const d=await async function(e,t,i){return i||await new Promise(((i,s)=>{let a=!1,r=null;const o=e=>{r&&clearTimeout(r),!a&&s(e)};e.audioWorklet.addModule(t.workletUrl||"data:text/javascript;base64,LyoqCiAqIEB0eXBlZGVmIHt7CiAqIGR1cmF0aW9uOiBudW1iZXIKICogZm9ybWF0OiBzdHJpbmcKICogbnVtYmVyT2ZDaGFubmVsczogbnVtYmVyCiAqIG51bWJlck9mRnJhbWVzOiBudW1iZXIKICogc2FtcGxlUmF0ZTogbnVtYmVyCiAqIHRpbWVzdGFtcDogbnVtYmVyCiAqIGRhdGE6IEZsb2F0MzJBcnJheQogKiB9fSBBdWRpb0RhdGFOb3JtYWwKICoKICogQHR5cGVkZWYge3sKICogICBkYXRhOiBGbG9hdDMyQXJyYXksCiAqICAgbmJTYW1wbGVzOiBudW1iZXIsCiAqICAgcmF0ZTogbnVtYmVyCiAqIH19IEF1ZGlvRGF0YUluUmF0ZQogKi8KCmNvbnN0IEhBVkVfTU9SRV9GUkFNRV9QTEFZID0gMgpjb25zdCBMT05HX1RJTUVfTk9fREVDT0RFRF9EUkFNRSA9IDEwCgovLyBBdWRpb1dvcmtsZXRQcm9jZXNzb3Ig5piv5rWP6KeI5ZmoIEFQSQoKY2xhc3MgUmVwbGFjZVNhbXBsZVByb2Nlc3NvciBleHRlbmRzIEF1ZGlvV29ya2xldFByb2Nlc3NvciB7CiAgLyoqIEB0eXBlIHtBcnJheVtBdWRpb0RhdGFOb3JtYWwgfCBBdWRpb0RhdGFJblJhdGVdfSAqLwogIF9mcmFtZVF1ZXVlID0gW10KICBfc2FtcGxlT2Zmc2V0SW5DdXJyZW50RnJhbWUgPSAwCiAgX2N1cnJlbnRGcmFtZSA9IG51bGwKICBfZmlyc3RUaW1lID0gdHJ1ZQogIF9zYW1wbGVQcmVGcmFtZSA9IDEwMjQKICBfdGFyZ2V0U2FtcGxlUGVyRnJhbWUgPSAxMDI0CiAgX291dFJhdGUgPSAxCiAgX3NhbXBsZUluZGV4SW5UYXJnZXRGcmFtZSA9IDAKICBfbG9uZ1RpbWVOb0RlY29kZWRGcmFtZSA9IGZhbHNlCiAgX2VtcHR5Q291bnQgPSAwCiAgX2Rlc3Ryb3llZCA9IGZhbHNlCgogIGNvbnN0cnVjdG9yIChhcmdzKSB7CiAgICBzdXBlcihhcmdzKQogICAgdGhpcy5wb3J0Lm9ubWVzc2FnZSA9IHRoaXMuX29uTWVzc2FnZQogICAgY29uc3QgeyBzYW1wbGVSYXRlLCBudW1DaGFubmVscywgbG91ZG5lc3NCYWxhbmNlLCBsb2dPbiB9ID0gYXJncy5wcm9jZXNzb3JPcHRpb25zCiAgICB0aGlzLl9zYW1wbGVSYXRlID0gc2FtcGxlUmF0ZQogICAgdGhpcy5fbnVtQ2hhbm5lbHMgPSBudW1DaGFubmVscwogICAgdHJ5IHsKICAgICAgLy8g6Z+z6YeP5Z2H6KGhCiAgICAgIGlmIChsb3VkbmVzc0JhbGFuY2UpIHsKICAgICAgICBpZiAoIWdsb2JhbFRoaXMuRXF1YWxpemVyIC8qKiDmiZPljIXmlofku7blhaXlj6Mgd29ya2xldC5lcXVhbGl6ZXIudHMg5byV5YWlICovKSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oImxvdWRuZXNzIGJhbGFuY2UgaXMgY29uZmlndXJlZCwgYnV0IHRoZSBjb3JyZWN0IHdvcmtsZXQgaXMgbm90IGxvYWRlZCIpCiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbG91ZG5lc3NCYWxhbmNlLnRhcmdldEx1ZnMgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oJ2xvdWRuZXNzIGJhbGFuY2UgbGFja3MgdGFyZ2V0IGxvdWRuZXNzIGNvbmZpZ3VyYXRpb24uJykKICAgICAgICB9IGVsc2UgaWYgKChnbG9iYWxUaGlzLkVxdWFsaXplciAmJiBnbG9iYWxUaGlzLkVxdWFsaXplci5kaXNhYmxlZCkgfHwgKG51bUNoYW5uZWxzICYmIG51bUNoYW5uZWxzID4gMikgLyoqIOmfs+mHj+Wdh+ihoeaPkuS7tiBjaGFubmVsID4gMiDliJ3lp4vljJbkvJrmiqXplJkgKi8pIHsKICAgICAgICAgIC8vIOmfs+mHj+Wdh+ihoeWKn+iDveW3suiiq+W8guW4uOWFs+mXrQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl90dXJuT25Mb3VkbmVzc0JhbGFuY2UoCiAgICAgICAgICAgIHNhbXBsZVJhdGUsCiAgICAgICAgICAgIG51bUNoYW5uZWxzLAogICAgICAgICAgICBsb3VkbmVzc0JhbGFuY2UsCiAgICAgICAgICAgIGxvZ09uLAogICAgICAgICAgKQogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCB7CiAgICAgIC8vCiAgICB9CiAgfQoKICBfdHVybk9uTG91ZG5lc3NCYWxhbmNlKAogICAgc2FtcGxlUmF0ZSwKICAgIG51bUNoYW5uZWxzLAogICAgbG91ZG5lc3NCYWxhbmNlLAogICAgbG9nT24sCiAgKSB7CiAgICBnbG9iYWxUaGlzLkVxdWFsaXplci5sb2dPbiA9IGxvZ09uCiAgICB0aGlzLl9lcXVhbGl6ZXIgPSBuZXcgZ2xvYmFsVGhpcy5FcXVhbGl6ZXIoewogICAgICBzYW1wbGVSYXRlLAogICAgICBudW1DaGFubmVscywKICAgICAgdGFyZ2V0THVmczogbG91ZG5lc3NCYWxhbmNlLnRhcmdldEx1ZnMsCiAgICAgIHNjb3BlOiBsb3VkbmVzc0JhbGFuY2Uuc2NvcGUsCiAgICB9KQogICAgdGhpcy5fZXF1YWxpemVyLm9uY2UoJ3JlYWR5JywgKCkgPT4geyAKICAgICAgdGhpcy5wb3J0LnBvc3RNZXNzYWdlKHsgdHlwZTogJ2xvdWRuZXNzQmFsYW5jZScsIHN0YXR1czogJ3JlYWR5JyB9KSB9KQogICAgdGhpcy5fZXF1YWxpemVyLm9uY2UoJ2Vycm9yJywgKGVycikgPT4gewogICAgICB0aGlzLnBvcnQucG9zdE1lc3NhZ2UoeyB0eXBlOiAnbG91ZG5lc3NCYWxhbmNlRXJyb3InLCBtZXNzYWdlOiBlcnIgfHwgImxvdWRuZXNzIGJhbGFuY2UgZXJyb3IgaGFwcGVuZWQuIHVua25vd24gZXJyb3IuIiB9KSB9KQogIH0KCiAgX29uTWVzc2FnZSA9IChlKSA9PiB7CiAgICBpZiAoZS5kYXRhLnR5cGUgPT09ICdmcmFtZScpIHsKICAgICAgdGhpcy5fZnJhbWVRdWV1ZS5wdXNoKGUuZGF0YS5kYXRhKQogICAgICBpZiAodGhpcy5fbG9uZ1RpbWVOb0RlY29kZWRGcmFtZSAmJiB0aGlzLl9mcmFtZVF1ZXVlLmxlbmd0aCA+IEhBVkVfTU9SRV9GUkFNRV9QTEFZKSB7CiAgICAgICAgdGhpcy5fbG9uZ1RpbWVOb0RlY29kZWRGcmFtZSA9IGZhbHNlCiAgICAgIH0KICAgIH0KCiAgICBpZiAoZS5kYXRhLnR5cGUgPT09ICdwcm9maWxlJykgewogICAgICBpZiAoZS5kYXRhLmhlQUFDKSB7CiAgICAgICAgdGhpcy5fc2FtcGxlUHJlRnJhbWUgPSAyMDQ4CiAgICAgICAgdGhpcy5fdGFyZ2V0U2FtcGxlUGVyRnJhbWUgPSAyMDQ4CiAgICAgIH0KICAgIH0KCiAgICBpZiAoZS5kYXRhLnR5cGUgPT09ICdjbGVhbicpIHsKICAgICAgdGhpcy5fZnJhbWVRdWV1ZSA9IFtdCiAgICB9CgogICAgaWYgKGUuZGF0YS50eXBlID09PSAnZGVzdHJveScpIHsKICAgICAgdGhpcy5wb3J0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCB0aGlzLl9vbk1lc3NhZ2UpCiAgICAgIHRoaXMuX2Rlc3Ryb3llZCA9IHRydWUKICAgICAgdGhpcy5fZnJhbWVRdWV1ZSA9IG51bGwKICAgICAgdGhpcy5fY3VycmVudEZyYW1lID0gbnVsbAogICAgICB0aGlzLl9lcXVhbGl6ZXI/LmRlc3Ryb3koKQogICAgICB0aGlzLl9lcXVhbGl6ZXIgPSBudWxsCiAgICB9CgogICAgaWYgKGUuZGF0YS50eXBlID09PSAnbG91ZG5lc3MnKSB7CiAgICAgIHRoaXMuX2VxdWFsaXplcj8uYWRkTG91ZG5lc3MoZS5kYXRhLmxvdWRuZXNzKQogICAgfQogIH0KCiAgX2NoZWNrU2V0U3BlZWRTdGF0ZSAoZikgewogICAgaWYgKGYucmF0ZSkgewogICAgICAvLyDpgJ/njofmlLnlj5gKICAgICAgaWYgKGYucmF0ZSAhPT0gdGhpcy5fb3V0UmF0ZSkgewogICAgICAgIHRoaXMuX291dFJhdGUgPSBmLnJhdGUKICAgICAgICB0aGlzLl90YXJnZXRTYW1wbGVQZXJGcmFtZSA9IHBhcnNlSW50KHRoaXMuX3NhbXBsZVByZUZyYW1lIC8gdGhpcy5fb3V0UmF0ZSkKICAgICAgfQogICAgICAvLyDmgaLlpI3miJAxCiAgICB9IGVsc2UgaWYgKHRoaXMuX291dFJhdGUgIT09IDEpIHsKICAgICAgdGhpcy5fb3V0UmF0ZSA9IDEKICAgICAgdGhpcy5fdGFyZ2V0U2FtcGxlUGVyRnJhbWUgPSBwYXJzZUludCh0aGlzLl9zYW1wbGVQcmVGcmFtZSAvIHRoaXMuX291dFJhdGUpCiAgICB9CiAgfQogIC8qKgogICAqIOS4gOasoeWkhOeQhjEyOOmHh+agtwogICAqLwogIHByb2Nlc3MgKGlucHV0cywgb3V0cHV0cykgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgcmV0dXJuIGZhbHNlCiAgICBjb25zdCBzb3VyY2VMaW1pdCA9IE1hdGgubWluKGlucHV0cy5sZW5ndGgsIG91dHB1dHMubGVuZ3RoKQoKICAgIGlmICh0aGlzLl9maXJzdFRpbWUpIHsKICAgICAgdGhpcy5fZmlyc3RUaW1lID0gZmFsc2UKICAgIH0KCiAgICBmb3IgKGxldCBpbnB1dE51bSA9IDA7IGlucHV0TnVtIDwgc291cmNlTGltaXQ7IGlucHV0TnVtKyspIHsKICAgICAgY29uc3QgaW5wdXQgPSBpbnB1dHNbaW5wdXROdW1dCiAgICAgIGNvbnN0IG91dHB1dCA9IG91dHB1dHNbaW5wdXROdW1dCiAgICAgIGNvbnN0IGNoYW5uZWxDb3VudCA9IE1hdGgubWluKGlucHV0Lmxlbmd0aCwgb3V0cHV0Lmxlbmd0aCkKICAgICAgaWYgKGNoYW5uZWxDb3VudCA8PSAwKSB7CiAgICAgICAgYnJlYWsKICAgICAgfQogICAgICBpZiAoY2hhbm5lbENvdW50ICE9PSB0aGlzLl9udW1DaGFubmVscykgewogICAgICAgIHRoaXMuX251bUNoYW5uZWxzID0gY2hhbm5lbENvdW50CiAgICAgICAgdGhpcy5fZXF1YWxpemVyPy51cGRhdGVNZXRhKHsKICAgICAgICAgIHNhbXBsZVJhdGU6IHRoaXMuX3NhbXBsZVJhdGUsCiAgICAgICAgICBudW1DaGFubmVsczogY2hhbm5lbENvdW50LAogICAgICAgIH0pCiAgICAgIH0KICAgICAgY29uc3Qgc2FtcGxlQ291bnQgPSBpbnB1dFswXS5sZW5ndGggLy8g5YGH6K6+5omA5pyJ6YCa6YGT55qE5qC35pys5pWw6YeP55u45ZCMCiAgICAgIGZvciAobGV0IHNhbXBsZU51bSA9IDA7IHNhbXBsZU51bSA8IHNhbXBsZUNvdW50OyBzYW1wbGVOdW0rKykgewogICAgICAgIGxldCBuYlNhbXBsZXMgPSB0aGlzLl9zYW1wbGVQcmVGcmFtZQogICAgICAgIGZvciAobGV0IGNoYW5uZWxOdW0gPSAwOyBjaGFubmVsTnVtIDwgY2hhbm5lbENvdW50OyBjaGFubmVsTnVtKyspIHsKICAgICAgICAgIC8vIE1hbmlwdWxhdGUgdGhlIHNhbXBsZQogICAgICAgICAgaWYgKCF0aGlzLl9mcmFtZVF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICBvdXRwdXRbY2hhbm5lbE51bV1bc2FtcGxlTnVtXSA9IGlucHV0W2NoYW5uZWxOdW1dW3NhbXBsZU51bV0KICAgICAgICAgICAgdGhpcy5fc2FtcGxlT2Zmc2V0SW5DdXJyZW50RnJhbWUgPSAwCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9jdXJyZW50RnJhbWUgPSB0aGlzLl9jdXJyZW50RnJhbWUgfHwgdGhpcy5fZnJhbWVRdWV1ZVswXQogICAgICAgICAgbmJTYW1wbGVzID0gdGhpcy5fY3VycmVudEZyYW1lPy5uYlNhbXBsZXMgfHwgdGhpcy5fY3VycmVudEZyYW1lPy5udW1iZXJPZkZyYW1lcyB8fCB0aGlzLl9zYW1wbGVQcmVGcmFtZQogICAgICAgICAgLy8gdGhpcy5fY2hlY2tTZXRTcGVlZFN0YXRlKHRoaXMuX2N1cnJlbnRGcmFtZSkKICAgICAgICAgIG91dHB1dFtjaGFubmVsTnVtXVtzYW1wbGVOdW1dID0gdGhpcy5fY3VycmVudEZyYW1lLmRhdGFbdGhpcy5fc2FtcGxlT2Zmc2V0SW5DdXJyZW50RnJhbWUgKyBjaGFubmVsTnVtICogbmJTYW1wbGVzXQogICAgICAgIH0KICAgICAgICB0aGlzLl9zYW1wbGVPZmZzZXRJbkN1cnJlbnRGcmFtZSsrCiAgICAgICAgdGhpcy5fc2FtcGxlSW5kZXhJblRhcmdldEZyYW1lKysKICAgICAgICBpZiAoCiAgICAgICAgICB0aGlzLl9zYW1wbGVPZmZzZXRJbkN1cnJlbnRGcmFtZSA+PQogICAgICAgICAgbmJTYW1wbGVzCiAgICAgICAgKSB7CiAgICAgICAgICB0aGlzLl9zYW1wbGVPZmZzZXRJbkN1cnJlbnRGcmFtZSA9IDAKICAgICAgICAgIHRoaXMuX2ZyYW1lUXVldWUuc2hpZnQoKQogICAgICAgICAgdGhpcy5fY3VycmVudEZyYW1lID0gdGhpcy5fZnJhbWVRdWV1ZVswXQogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fc2FtcGxlSW5kZXhJblRhcmdldEZyYW1lID49IHRoaXMuX3RhcmdldFNhbXBsZVBlckZyYW1lKSB7CiAgICAgICAgICB0aGlzLl9zYW1wbGVJbmRleEluVGFyZ2V0RnJhbWUgPSAwCiAgICAgICAgICB0aGlzLnBvcnQucG9zdE1lc3NhZ2UoewogICAgICAgICAgICB0eXBlOiAnYXVkaW9SZW5kZXJlZCcsCiAgICAgICAgICAgIG91dFJhdGU6IHRoaXMuX291dFJhdGUsCiAgICAgICAgICB9KQogICAgICAgIH0KICAgICAgfQogICAgICAvLyDpn7Pph4/lnYfooaEKICAgICAgdGhpcy5fZXF1YWxpemVyPy5wcm9jZXNzKG91dHB1dCkKICAgIH0KCgogICAgaWYgKCF0aGlzLl9mcmFtZVF1ZXVlLmxlbmd0aCAmJiAhdGhpcy5fbG9uZ1RpbWVOb0RlY29kZWRGcmFtZSkgewogICAgICB0aGlzLl9lbXB0eUNvdW50KysKICAgICAgaWYgKHRoaXMuX2VtcHR5Q291bnQgPiBMT05HX1RJTUVfTk9fREVDT0RFRF9EUkFNRSApIHsKICAgICAgICB0aGlzLl9sb25nVGltZU5vRGVjb2RlZEZyYW1lID0gdHJ1ZQogICAgICAgIHRoaXMuX2VtcHR5Q291bnQgPSAwCiAgICAgICAgdGhpcy5wb3J0LnBvc3RNZXNzYWdlKHsKICAgICAgICAgIHR5cGU6ICdhdWRpb0RlY29kZUxhZycsCiAgICAgICAgfSkKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQp9CgovLyByZWdpc3RlclByb2Nlc3NvciDmmK/mtY/op4jlmaggQVBJCgpyZWdpc3RlclByb2Nlc3NvcignbXktd29ya2xldC1wcm9jZXNzb3InLCBSZXBsYWNlU2FtcGxlUHJvY2Vzc29yKQo=").then((()=>{r&&clearTimeout(r),!a&&(a=!0,i())})).catch(o),r=setTimeout((()=>{o(new Error("audio worklet processor url load timeout"))}),t.workletTimeout)})),new AudioWorkletNode(e,"my-worklet-processor",{processorOptions:{sampleRate:t.sampleRate,numChannels:t.numChannels,loudnessBalance:t.loudnessBalance,logOn:E()}})}(h,{...t,sampleRate:s,numChannels:r},!!l),c=new OscillatorNode(h,{type:"sine"}),_=new GainNode(h,{channelCount:r,channelCountMode:"explicit",channelInterpretation:"speakers"}),g=h.createMediaStreamDestination();return g.channelCount=r,c.connect(_),_.connect(d),d.connect(g),d.port.postMessage({type:"profile",heAAC:a}),o&&d.port.postMessage({type:"loudness",loudness:o}),{sampleRate:s,heAAC:a,track:g.stream.getAudioTracks()[0],writable:d.port,ctx:h,workletNode:d,oscillatorNode:c,disconnect:function(){try{if(!h||"closed"===h.state)return;h.suspend().catch((e=>{})),h.removeEventListener("error",i),w.log(`cache audioContext! sampleRate=${s}, heAAC=${a}`),T.cache({sampleRate:s,heAAC:a,ctx:h}),g.disconnect(),d.disconnect(g),_.disconnect(d),c.disconnect(_),h=null}catch{}}}}(e,this._opts,this.onAudioCtxError)}catch(e){return void this.onVEError(p.create(_.RENDER,"RENDER_WORKLET_INIT_ERROR",e))}if(e.video)try{a=function(){const e=new MediaStreamTrackGenerator({kind:"video"});return{track:e,writable:e.writable}}()}catch(e){return void this.onVEError(p.create(_.RENDER,"RENDER_VIDEOTRACK_INIT_ERROR",e))}if(this._errorInfo||(this._audioTrack=s,this._videoTrack=a,this.emit(d.WRITABLE,{videoWritable:null==a?void 0:a.writable,audioWritable:null==s?void 0:s.writable,autoplayPolicy:t,muted:i}),!this._media))return;const r=this._media.srcObject||new MediaStream,{oldV:o,oldA:n}=this._removeOldTracks(r);this._repaceMediaTrack=!(!n&&!o),this._audioTrack&&(r.addTrack(this._audioTrack.track),this.logger.log("replace audio track!")),this._videoTrack&&(r.addTrack(this._videoTrack.track),this.logger.log("replace video track!")),this._repaceMediaTrack&&(this.logger.warn("hack! call pause() -> play() in onInitRender"),this._media.pause(),this._media.play().catch((e=>{})))}onFirstFrame(e){this.logger.log(`firstframe show! ${(performance.now()-this._startTime).toFixed(0)} ms, now:${performance.now()}`,e),this._firstframeCost=e,this._repaceMediaTrack&&(this.logger.warn("mock emit canplay event"),this.dispatchEvent("canplay"))}onSwitchSuccess(e){this._srcUrl=e.url}onDuration(e){this._duration=e.duration,this.dispatchEvent("durationchange")}onCurrentTime(e){this._currentTime=e.time}onBufferUpdate(e){this._buffered.update(e)}onPlaybackRate(e){this._playbackRate=e.rate,this.dispatchEvent("ratechange")}onPlayEnd(){var e;this.logger.log("emit ended event!!"),this.dispatchEvent("ended"),null==(e=this._media)||e.pause()}onVEError(e){if(this.logger.log("主线程接受到error:",e),this._retryPlayForDecodeError(e)||this._errorInfo)return;const t=new Error(`subcode:${e.code}, module:${e.eType}. ${e.message}`);t.code=3,t.subCode=e.code,this._errorInfo=t,this.closeRender(),this.emit(d.ERROR),this.logger.log("对外抛错！"),this.dispatchEvent("error")}onLoudnessBalance(e){const{status:t}=e;"ready"==t&&(this.logger.log("Open Sound Balance"),this.emit(G.LOUDNESS_BALANCE_START))}onSEILoudness(e){this._firstLoudness||(this._firstLoudness=e),this.emit(G.SEI_LOUDNESS,e)}_retryPlayForDecodeError(e){return!!(p.isDecodingError(e)&&this._retryCountForDecodeError&&this._proxyMedia)&&(this.logger.log("retry play for midway decode error",this._retryCountForDecodeError),this._retryCountForDecodeError-=1,this.emit(d.SEAMLESS_LOAD_STREAM,{url:this._srcUrl}),!0)}_removeOldTracks(e){if(!e)return{};const t=e.getVideoTracks()[0],i=e.getAudioTracks()[0];return i&&e.removeTrack(i),t&&e.removeTrack(t),{oldV:t,oldA:i}}_handlePlayPolicy(){this._media&&(this._media.addEventListener("play",this._onMediaPlay),this._media.addEventListener("pause",this._onMediaPause),this._media.addEventListener("canplay",this._onOnceCanplay),this._media.addEventListener("volumechange",this._onMediaVolumeChange),this._media.addEventListener("loadeddata",this._onMediaLoadeddata),document.addEventListener("visibilitychange",this._visibilityChanged))}_unbindMediaEvent(){this._media&&(this._media.removeEventListener("play",this._onMediaPlay),this._media.removeEventListener("pause",this._onMediaPause),this._media.removeEventListener("volumechange",this._onMediaVolumeChange),this._media.removeEventListener("loadeddata",this._onMediaLoadeddata),this._media.removeEventListener("canplay",this._onOnceCanplay),document.removeEventListener("visibilitychange",this._visibilityChanged))}}o(L,"WebAudioPool",T);class N{constructor(e){o(this,"_map"),this._map=e}get(e){return this._map[e]}}E()&&y.setEnable(!0);class F extends s.Ay{constructor(e){var t,i;super(e),o(this,"logger",new y("FlvPlugin")),o(this,"_ve",null),o(this,"_loaderInfo",{totalByteSize:0,currentSpeed:0,avgSpeed:0,recentSpeed:0,responseHeader:new N({})}),o(this,"_endedStatus",{}),o(this,"_videoMeta",null),o(this,"_audioMeta",null),o(this,"switchURL",((e,t)=>(t?this.player.video.srcseamless=e:(this.player.config.url=e,this.player.video.src=e),Promise.resolve()))),o(this,"switchCancel",(()=>{var e;null==(e=this._ve)||e.switchCancel()})),o(this,"_onURLChange",(e=>{var t,i;this._ve&&null!=(i=null==(t=this.player)?void 0:t.config)&&i.url&&(this.player.config.url=e)})),this.logger.log("init flv plugin. config:",JSON.stringify(this.config,null,4),`[${performance.now()}]`),y.enable&&this.logger.log("player:",this.player);const s="HTMLVideoElement"===(null==(t=e.player.video.constructor)?void 0:t.name);this.logger.log("player.video is origin HTMLVideoElement?",s);const r=new L({media:s?e.player.video:e.player.video.media,workletUrl:this.config.workletUrl,workletTimeout:this.config.workletTimeout,workerUrl:this.config.workerUrl,retryCountForDecodeError:this.config.retryCountForDecodeError,loudnessBalance:this.config.loudnessBalance});s?e.player.video=r.adapt():e.player.video.media=r.adapt(),this.config.Decryptor&&delete this.config.Decryptor,r.updateProtoConfig(this.config),this._ve=r,this._bindVEEvent(),this.player.switchCancel=this.switchCancel,null==(i=this.player)||i.useHooks("replay",(()=>this._replay())),this.on(a.URL_CHANGE,this._onURLChange)}static get pluginName(){return"flvLive"}static get defaultConfig(){return{url:"",retryCount:3,retryDelay:1e3,loadTimeout:1e4,preloadTime:5,maxReaderInterval:5e3,seiOnDemand:!1,seamlesslyReload:!0,chaseFrameStart:0,analyzeDuration:2e3,disconnectTime:0,fetchOptions:{},onlyVideo:!1,loudnessParserOn:!0,workletUrl:"",workerUrl:"",Decryptor:null,workletTimeout:1e4,retryCountForDecodeError:2,retryForLowlatency:{open:!0,checkPlayTimeUtil:3.5,lowLatency:1}}}static isSupported(){return typeof MediaStreamTrackGenerator<"u"&&typeof VideoDecoder<"u"&&typeof AudioDecoder<"u"&&typeof EncodedVideoChunk<"u"&&typeof EncodedAudioChunk<"u"}get version(){return"0.1.12-rc.0"}get core(){return{}}get context(){return null}get playMode(){return"WebCodec"}get loader(){return this._loaderInfo}get endedStatus(){return this._endedStatus}get transferCost(){return null}get stableStats(){return{}}get firstframeInfo(){var e;return(null==(e=this._ve)?void 0:e.getFirstframeCost())||{}}beforePlayerInit(){this.player.switchURL=this.switchURL}destroy(){var e,t;this.logger.log("destroy!");const i=null==(e=this._ve)?void 0:e.media;null==(t=this._ve)||t.reset(),this._ve&&(this.player.video=i),this._ve=null}getStats(){var e,t,i,s,a,r;return{codec:(null==(e=this._videoMeta)?void 0:e.codec)||"",audioCodec:(null==(t=this._audioMeta)?void 0:t.codec)||"",width:(null==(i=this._videoMeta)?void 0:i.presentWidth)||0,height:(null==(s=this._videoMeta)?void 0:s.presentHeight)||0,frameRate:(null==(a=this._videoMeta)?void 0:a.frameRate)||0,sampleRate:(null==(r=this._audioMeta)?void 0:r.sampleRate)||0,currentSpeed:this._loaderInfo.currentSpeed||0,totalByteSize:this._loaderInfo.totalByteSize||0}}_replay(){return this._ve&&(this.player.video.src=this.player.config.url),!0}_bindVEEvent(){this._ve&&(this._transPluginEvent(G.TTFB),this._transPluginEvent(G.CHASE_FRAME),this._transPluginEvent(G.LOADRETRY),this._transPluginEvent(G.SEI),this._transPluginEvent(G.SEI_LOUDNESS),this._transPluginEvent(G.SWITCH_START),this._transPluginEvent(G.LOUDNESS_BALANCE_START),this._transPluginEvent(G.STREAM_EXCEPTION),this._transPluginEvent(d.MESSAGE_CATCH_AUDIOCTX_ERROR),this._ve.on(G.KEYFRAME,(e=>{this.player.emit(G.KEYFRAME,e.pts)})),this._ve.on(G.RESPONSEHEADERS,(e=>{const t=new N(e.headers);this.player.emit(G.RESPONSEHEADERS,t),this._loaderInfo.responseHeader=t})),this._ve.on(G.PROP_SPEED,(e=>{this._loaderInfo.totalByteSize=e.totalByteSize,this._loaderInfo.currentSpeed=e.currentSpeed,this._loaderInfo.avgSpeed=e.avgSpeed,this._loaderInfo.recentSpeed=e.recentSpeed})),this._ve.on(G.PROP_ENDEDSTATUS,(e=>{delete e.type,this._endedStatus=e})),this._ve.on(G.METADATA,(e=>{const t=e.trackType;delete e.trackType,e.type=t,"video"===t&&(this._videoMeta=e),"audio"===t&&(this._audioMeta=e),this.player.emit(G.METADATA,t,e)})),this._ve.on(G.SWITCH_COMPLETE,(e=>{this.logger.log("switch complete!",e),this.player.config.url=e.url,this.player.emit(G.SWITCH_COMPLETE,e)})),this._ve.on(G.FLVERROR,(e=>{this.player.emit("error",V(e))})),this._ve.on(G.SWITCH_ERROR,(e=>{this.player.emit(G.SWITCH_ERROR,V(e))})))}_transPluginEvent(e){this._ve.on(e,(t=>{t&&delete t.type,this.player.emit(e,t)}))}}o(F,"FlvCoreEvent",G),L.FlvPlugin=F},80470:(e,t,i)=>{i.r(t),i.d(t,{default:()=>w,sniffer:()=>o});var s=Object.defineProperty,a=(e,t,i)=>((e,t,i)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i);let r={get device(){return r.os.isPc?"pc":"mobile"},get browser(){const{type:e,versions:t}=function(){var e=navigator.userAgent.toLowerCase(),t={},i={IE:window.ActiveXObject||"ActiveXObject"in window,Chrome:e.indexOf("chrome")>-1&&e.indexOf("safari")>-1,Firefox:e.indexOf("firefox")>-1,Opera:e.indexOf("opera")>-1,Safari:e.indexOf("safari")>-1&&-1==e.indexOf("chrome"),Edge:e.indexOf("edge")>-1,QQBrowser:/qqbrowser/.test(e),WeChBrowser:/MicroMessenger/i.test(e)};for(var s in i)if(i[s]){var a="";if("IE"===s)a=e.match(/(msie\s|trident.*rv:)([\w.]+)/)[2];else if("Chrome"===s){const t=e.match(/chrome\/([\d.]+)/);a=t?t[1]:"-1"}else if("Firefox"===s){const t=e.match(/firefox\/([\d.]+)/);a=t?t[1]:"-1"}else if("Opera"===s){const t=e.match(/opera\/([\d.]+)/);a=t?t[1]:"-1"}else if("Safari"===s){const t=e.match(/version\/([\d.]+)/);a=t?t[1]:"-1"}else if("Edge"===s){const t=e.match(/edge\/([\d.]+)/);a=t?t[1]:"-1"}else if("QQBrowser"===s){const t=e.match(/qqbrowser\/([\d.]+)/);a=t?t[1]:"-1"}t.type=s,t.versions=parseInt(a)}return t}();return`${e}_${t}`},get os(){let e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,s=/(?:Android)/.test(e),a=/(?:Firefox)/.test(e),r=/(?:iPad|PlayBook)/.test(e)||s&&!/(?:Mobile)/.test(e)||a&&/(?:Tablet)/.test(e),o=/(?:iPhone)/.test(e)&&!r;return{isTablet:r,isPhone:o,isAndroid:s,isPc:!(o||s||i||r),isSymbian:i,isWindowsPhone:t,isFireFox:a}},get operation_os(){let e=navigator.userAgent;const t=[{s:"windows",r:/(Windows 10.0|Windows NT 10.0|Windows NT 10.1|Windows 8.1|Windows NT 6.3|Windows 8|Windows NT 6.2|Windows 7|Windows NT 6.1)/},{s:"android",r:/Android/},{s:"linux",r:/(Linux|X11)/},{s:"ios",r:/(iPhone|iPad|iPod)/},{s:"mac",r:/Mac OS X/},{s:"mac",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/}];for(let i=0;i<t.length;i++){let s=t[i];if(s.r.test(e))return s.s}return"unknown"}};const o=r,n="living_device_id",l="living_user_id",h=e=>{if(!document.cookie)return null;const t=document.cookie.split(";");for(let i=0,s=t.length;i<s;i++){const s=t[i];if(t[i].indexOf(e)>=0)return s.split("=")[1]||null}},d=e=>String(Math.floor(Math.random()*Math.pow(10,e))),c=()=>{const e=h(n);if(e)return e;const t=d(11);return document.cookie=`${n}=${t};max-age=31536000;path=/`,t},_=()=>{const e=h(l);if(e)return e;const t=d(12);return document.cookie=`${l}=${t};max-age=31536000;path=/`,t};function g(){return(new Date).getTime()}function p(e){const t="unknown";return"string"!=typeof e?t:e.indexOf(".flv")>-1?"flv":e.indexOf(".m3u8")>-1?"m3u8":e.indexOf(".mp4")>-1?"mp4":e.indexOf(".sdp")>-1?"rts":t}function u(e){return typeof MediaSource<"u"?+MediaSource.isTypeSupported(`video/mp4; codecs=${e}`):0}const m=[{key:"ld5",value:"h265"},{key:"sd5",value:"h265"},{key:"uhd560",value:"h265"},{key:"uhd5",value:"h265"},{key:"hd560",value:"h265"},{key:"hd5",value:"h265"},{key:"ld",value:"h264"},{key:"sd",value:"h264"},{key:"uhd60",value:"h264"},{key:"hd60",value:"h264"},{key:"uhd",value:"h264"},{key:"hd",value:"h264"},{key:"or4",value:"h264"},{key:"",value:"unknow"}];function y(e){try{if(!e)return"unknow";const t=/(_[^.]+).flv/.exec(e);if(!t||!t[1])return"unknow";const i=t[1];for(let e=0,t=m.length;e<t;e++){const t=m[e].key;if(-1!==i.indexOf(t))return m[e].value}}catch{}return"unknow"}let f=null;function E(e){if(e.plugins){if(e.plugins.flvlive)return e.plugins.flvlive;if(e.plugins.hlslive)return e.plugins.hlslive;if(e.plugins.hlsvod)return e.plugins.hlsvod;if(e.plugins.hlslivemobile)return e.plugins.hlslivemobile;if(e.plugins.flvlivemobile)return e.plugins.flvlivemobile;if(e.plugins.rts)return e.plugins.rts}return e.newHls||e.newFlv||e.__core__||e.flv}function C(){try{return"0.1.11"}catch{}return""}function I(e){const t=e.player,i=t.config.url&&t.config.url.startsWith("//")?window.location.protocol+t.config.url:t.config.url;return{project_key:e.project_key,live_sdk_version:E(t)||t.hlsOps?"2":"-1",player_sdk_version:t.version,logger_version:C(),report_version:"5",fps:0,product_line:e.product_line,user_id:e.user_id,device_id:e.device_id,logger_id:d(12),app_name:e.app_name,cdn_ip:e.cdn_ip,is_wasm:["xg-video","mobile-video","live-video"].indexOf(t.config.mediaType)>-1?1:0,review_is_live:t.config.isLive?2:1,aid:e.aid,live_id:e.live_id||`${e.aid}-${e.user_id}-${Date.now()}`,is_preview:e.is_preview?1:0,codec_type:e.codec_type||"h264",width:Math.floor(t.config.width),height:Math.floor(t.config.height),browser:o.browser,ua:navigator.userAgent,timestamp:0,logger_init_time:Date.now(),isSupportedH265:u("hev1.1.6.L93.B0,mp4a.40.2"),codec_support:-1,play_current_time:0,cdn_play_url:i,play_format:p(i),codec_byurl:y(i),decode_img_fps:-1,copy_fps:-1,performance_speed:-1,cpu_score:-1,bandwidth_score:-1,device_score:-1,cpu_core_number:navigator.hardwareConcurrency||-1,memory_usage:-1,network_downlink:-1,memory_score:-1,set_timer_cost:-1,gpu_vendor:localStorage.getItem("g_ven")||"",play_core:"Mse",bg_play:0,loudness_balance:0,...e.ext}}const A={1:"MEDIA_ERR_ABORTED",2:"MEDIA_ERR_NETWORK",3:"MEDIA_ERR_DECODE",4:"MEDIA_ERR_SRC_NOT_SUPPORTED"};class v{constructor(e){const{Tea:t}=e;if(!t)throw new Error("lack Tea option");t.event?this.Tea=t.event.bind(t):this.Tea=t,this.logOptions=e,this._player=e.player}push(e){var t;const{url:i}=this._player.config;var s;this._player.video&&(e.play_current_time=this._player.currentTime),e.muted=+this._player.muted,e.cdn_play_url=i&&i.startsWith("//")?window.location.protocol+i:i,e.live_stream_session_id=function(e){return new URLSearchParams(e.split("?")[1]).get("_session_id")||""}(i),e.play_session_id=e.live_stream_session_id,e.play_format=p(i),e.timestamp=g(),e.href=window.location.href,e.codec_shortname="h264"===(s=e).codec_type&&"h265"===s.codec_byurl||-1!==(s.codec_type||"").indexOf("hev1")?"h265":"h264",null!=(t=this.logOptions)&&t.openLogger&&console.log(`[logger report]: ${e.event_key}`,e),this.send(e)}send(e){e.event_key&&(this.logOptions.onReport&&this.logOptions.onReport(e.event_key,e),this.Tea(e.event_key,{...e}))}}const R=["play","playing","pause","ended","error","seeking","seeked","timeupdate","waiting","canplay","canplaythrough","durationchange","ratechange","volumechange","loadeddata"],b="WebCodec";let S=o.browser.includes("Chrome");class T{constructor(e){if(a(this,"_visibilityChannged",(()=>{try{"visible"===document.visibilityState&&(this.commonParams.bg_play=0),"hidden"===document.visibilityState&&(this.commonParams.bg_play=1)}catch{}})),a(this,"handleRetry",(e=>{var t,i,s;this.core||(this.core=E(this.player)),this.log.play_stop.retry_count++,this._logmanager.push(Object.assign({},this.log.play_fetch_retry,e,{code:null==(t=null==e?void 0:e.error)?void 0:t.code,load_timeout:null==(s=null==(i=this.core)?void 0:i.config)?void 0:s.loadTimeout}))})),a(this,"handleSwitchStart",(e=>{this._logmanager.push({event_key:"seamless_switch_start",switch_url:null==e?void 0:e.url})})),a(this,"handleSwitchComplete",(e=>{this._logmanager.push({event_key:"seamless_switch_complete",switch_url:null==e?void 0:e.url})})),a(this,"handleSwitchError",(e=>{this._logmanager.push({event_key:"seamless_switch_error",switch_url:null==e?void 0:e.url,...e})})),a(this,"handleStreamException",((e={})=>{this._logmanager.push({...this.log.play_stream_exception,...e})})),a(this,"handleCatchAudioCtxError",(e=>{this._logmanager.push({...this.log.play_catch_audioctx_error,...e})})),a(this,"handlePlaybackrateChange",(()=>{1!==this.player.playbackRate&&(this.log.playing.ratechange_count+=1)})),a(this,"_onceFlvResponseHeaders",(e=>{if(!this.player)return;const t=e.get("X-Server-Ip");t&&(this.commonParams.cdn_ip=t)})),a(this,"_onFlvMetadata",((e,t)=>{this.log.play_stop.meta=this.log.play_stop.meta||{},e&&(this.log.play_stop.meta[e]=t),this.handleMetaDataLoadedForWebCodec(e,t)})),a(this,"cycleReportPlaying",(()=>{let e=this.options.playingInterval||1e4;(Math.abs(Date.now()-this.log.playing.timestamp-e)<100||Date.now()-this.log.playing.timestamp>=e)&&this.reportPlaying(),this.intervalId=setTimeout(this.cycleReportPlaying,1e3)})),!e.player)throw new Error("option player is necessary");var t;this.options=Object.assign({},e,{device_id:(t=e).device_id||c(),user_id:t.user_id||_(),error_report_stop:void 0===t.error_report_stop||!!t.error_report_stop,project_key:t.project_key||"live",product_line:t.product_line||"live",onReport:t.onReport||function(){},openLogger:t.openLogger||!1}),this.stallOut=this.options.stallOut||1e4,this._player=this.options.player,this._url=this._player.config.url,this.project_key=e.project_key||"live",this.product_line=e.product_line||"live",this.ntpDelta=this.options.ntp?Date.now()-this.options.ntp:0,this.inWaitingStart=0,this.errorNumber=0,this.tempFirstStallTime=0,this.tempDroppedFrameCount=0,this.tempTotalFrameCount=0,this._flvCoreEvtBound=!1,this._logmanager=new v(this.options),this.init(),this.started=!1,this.destroyed=!1,this.completed=!1,this.firstFrameViewed=!1,this.cacheRtcStats={},this.cachePlaying={demuxCost:0,remuxCost:0,appendCost:0,totalByteSize:0}}get videoSize(){return this.player?{width:this.player.video.videoWidth,height:this.player.video.videoHeight}:{width:0,height:0}}get player(){return this._player}get logmanager(){return this._logmanager}get ntpTime(){return Date.now()-this.ntpDelta}get isWebCodec(){if(!this.player)return!1;const e=E(this.player);return!!e&&e.playMode===b}setNTP(e){this.options&&(this.options.ntp=e,this.ntpDelta=Date.now()-this.options.ntp)}init(){this.bindCtx(),this.initLog(),this.initEvt()}bindCtx(){this.handlePlayerComplete=this.handlePlayerComplete.bind(this),this.handlePlayerPlaying=this.handlePlayerPlaying.bind(this),this.destroyFunc=this.destroyFunc.bind(this),this.handleUserLeave=this.handleUserLeave.bind(this),this.handlePlayerError=this.handlePlayerError.bind(this),this.handlePlayerReady=this.handlePlayerReady.bind(this),this.handlePlayerWaiting=this.handlePlayerWaiting.bind(this),this.handleAVUnsync=this.handleAVUnsync.bind(this),this.handleSEIParsed=this.handleSEIParsed.bind(this),this.handleSEILoudNessParsed=this.handleSEILoudNessParsed.bind(this),this.handlePlayerPause=this.handlePlayerPause.bind(this),this.handleTTFB=this.handleTTFB.bind(this),this.handleUrlChange=this.handleUrlChange.bind(this),this.handleKeyframe=this.handleKeyframe.bind(this),this.handleSourceOpen=this.handleSourceOpen.bind(this),this.handleBufferAppend=this.handleBufferAppend.bind(this),this.handleDegrade=this.handleDegrade.bind(this),this.handleLoadStart=this.handleLoadStart.bind(this),this.handlePlayerEnded=this.handlePlayerEnded.bind(this),this.handleAbrSwitch=this.handleAbrSwitch.bind(this),this.handleChaseFrame=this.handleChaseFrame.bind(this),this.handleUserAction=this.handleUserAction.bind(this),this.handleLoudnessBalanceStart=this.handleLoudnessBalanceStart.bind(this)}initLog(){const e=this.options,t=e.player,i=void 0!==t.hlsOps;this.commonParams={os:o.operation_os,...I(e)},this.log=Object.assign({},{start_play:{start_play_time:0,event_key:"start_play"},first_frame:{start:0,first_frame_view:0,event_key:"first_frame",first_sei_delay:0,time_worker_init:0,time_loadstream_start:0,time_decoder_init:0,time_render_init:0,time_first_sample:0,time_first_aframe:0,time_first_vframe:0,ntp_sync:0,ntp_delta:0,ttfb:-1,ttdb:-1,ttfb_end:0,loudness_peak:-1,loudness_luft:-1,loudness_integrated:-1,loudness_shorterm:-1,loudness_momentary:-1,video_codec:"",audio_codec:"",audioSampleRate:0,audioObjectType:0,audioChannelCount:0},first_frame_failed:{code:void 0,is_threshold:0,msg:"",event_key:"first_frame_failed"},stall_start:{ready_state:-1,stall_start_time:0,event_key:"stall_start"},stalling:{event_key:"stalling"},stall:{reason:0,remain_buffer:0,is_seeking:0,stall_start:0,stall_end:0,ready_state:0,event_key:"stall"},play_stop:{error_code:0,stop_time:0,drop_percent:0,is_stream_received:0,stall_count:0,stall_time:0,retry_count:0,duration:0,stall_count_per_100sec:0,stall_time_per_100sec:0,event_key:"play_stop",dns_parse_time:-1,redirect:-1,ttfb:-1,buffered:[],is_firstframe_received:0,meta:null},playing:{index:0,playing_index:0,accum_stall_time:0,accum_stall_count:0,accum_play_time:0,stall_count:0,stall_time:0,play_time:1e4,playing_interval:0,retry_count:0,is_last:0,video_buffer_time:0,audio_buffer_time:0,speed_switch_count:0,speed_switch_info:"none",download_speed:0,decode_fps:0,render_fps:-1,drop_count:0,drop_percent:0,playback_rate:1,ratechange_count:0,sei_source:"",sei_delay:0,ntp_sync:0,ntp_delta:0,event_key:"playing",stop_time:0,duration:0,stall_count_per_100sec:0,stall_time_per_100sec:0,abr_switch_count:0},play_error:{code:void 0,info:"",event_key:"play_error"},play_low_decode:{fps:-1,decode_fps:-1,bitrate:-1,url:-1,msg:"",event_key:"play_low_decode"},play_av_unsync:{aDts:-1,vDts:-1,frameLength:-1,currentTime:-1,duration:0,event_key:"play_av_unsync"},play_loadstream:{loadstream_url:"",event_key:"play_loadstream"},play_stream_loaded:{event_key:"play_stream_loaded"},play_metadata_loaded:{metadata_type:"",event_key:"play_metadata_loaded"},play_demux_error:{msg:"",event_key:"play_demux_error"},play_stream_discontinue:{type:"",dts:-1,event_key:"play_stream_discontinue"},pause:{event_key:"pause"},play_url_change:{event_key:"play_url_change"},source_opened:{event_key:"source_opened"},source_updateend:{event_key:"source_updateend"},play_result:{event_key:"play_result",result:0,threshold:15e3,is_threshold:0},degrade:{event_key:"degrade",payload:{}},play_ended:{event_key:"play_ended"},abr_switch:{event_key:"abr_switch",stall_count:0,switch_index:0},abr_session:{event_key:"abr_session",stall_time:0,end_buffer:0},play_chase_frame:{event_key:"play_chase_frame"},play_audio_gap:{event_key:"play_audio_gap"},play_audio_overlap:{event_key:"play_audio_overlap"},player_user_action:{event_key:"player_user_action"},play_fetch_retry:{event_key:"play_fetch_retry"},play_stream_exception:{event_key:"play_stream_exception"},play_catch_audioctx_error:{event_key:"catch_audioctx_error"}});const s=this;for(let e in this.log){for(let t in this.commonParams)Object.defineProperty(this.log[e],t,{get:function(){return null==this["_"+t]?s.commonParams[t]:this["_"+t]},set:function(e){this["_"+t]=e},enumerable:!0});i&&Object.defineProperty(this.log[e],"m3u8",{get:()=>{if(t&&t.__core__){const{m3u8Text:e}=t.__core__;return e?e.slice(0,25e4):""}return""},enumerable:!0}),Object.defineProperty(this.log[e],"volume",{get:()=>t&&t.video&&t.volume||0,enumerable:!0}),Object.defineProperty(this.log[e],"access",{get:()=>typeof navigator.onLine<"u"?navigator.onLine?(()=>{const{connection:e}=navigator;return e&&e.effectiveType})():"none":"unknown",enumerable:!0})}this.setMarkScore(f)}updateExt(e){for(let t in this.log)for(let i in e)this.log[t][i]=e[i]}updateOptions(e){Object.assign(this.commonParams,e)}reportStartPlay(){this.started||(this.started=!0,this.log.start_play.start_play_time=this.log.start_play.timestamp=g(),this.isWebCodec&&(this.commonParams.play_core=b),this.logmanager.push(this.log.start_play,!0))}initWindowListener(){"pc"===o.device?window.addEventListener("beforeunload",this.destroyFunc):"mobile"===o.device&&(window.addEventListener("beforeunload",this.destroyFunc),window.addEventListener("pagehide",this.destroyFunc)),document.addEventListener("visibilitychange",this._visibilityChannged)}removeWindowListener(){"pc"===o.device?window.removeEventListener("beforeunload",this.destroyFunc):"mobile"===o.device&&(window.removeEventListener("beforeunload",this.destroyFunc),window.removeEventListener("pagehide",this.destroyFunc)),document.removeEventListener("visibilitychange",this._visibilityChannged)}initEvt(){const{player:e}=this;R.forEach((e=>{this[`handleVideo${e}Evt`]=()=>{this[`handleVideo${e}`]&&this[`handleVideo${e}`]()},this.bindVideoEvt(e,this[`handleVideo${e}Evt`])})),this.initWindowListener(),e.once("error",this.handlePlayerError),e.once("complete",this.handlePlayerComplete),e.once("playing",this.handlePlayerPlaying),e.once("timeupdate",this.handlePlayerPlaying),e.once("destroy",this.destroyFunc),e.on("ready",this.handlePlayerReady),e.on("waiting",this.handlePlayerWaiting),e.on("SEI_PARSED",this.handleSEIParsed),e.on("SEI_LOUDNESS",this.handleSEILoudNessParsed),e.on("loudness_balance_start",this.handleLoudnessBalanceStart),e.on("pause",this.handlePlayerPause),e.on("ttfb",this.handleTTFB),e.on("urlchange",this.handleUrlChange),e.once("isKeyframe",this.handleKeyframe),e.once("sourceopen",this.handleSourceOpen),e.once("bufferappend",this.handleBufferAppend),e.on("degrade",this.handleDegrade),e.on("loadstart",this.handleLoadStart),e.on("ratechange",this.handlePlaybackrateChange),e.on("ended",this.handlePlayerEnded),e.on("chaseframe",this.handleChaseFrame),e.on("user_action",this.handleUserAction),e.on("retry",this.handleRetry),e.on("switch_start",this.handleSwitchStart),e.on("switch_completed",this.handleSwitchComplete),e.on("switch_error",this.handleSwitchError),e.on("streamexception",this.handleStreamException),e.on("catch_audioctx_error",this.handleCatchAudioCtxError);const t=e.plugins.abr;t&&t.on("abr_switch",this.handleAbrSwitch),this.hiJackPlayerStart()}handleUserAction(e){this.logmanager.push(Object.assign({},this.log.player_user_action,e))}handleChaseFrame(e){this.logmanager.push(Object.assign(this.log.play_chase_frame,e))}handlePlayerEnded(){if(this.core&&this.core.endedStatus){const{endOfStream:e,mock:t}=this.core.endedStatus;this.logmanager.push(Object.assign({},this.log.play_ended,this.core.endedStatus,{endOfStream:+e,mock:+t}))}}handleLoadStart(){if(this.core=E(this.player),this.core)if(this.commonParams.live_sdk_version="2",this.isWebCodec)this.commonParams.play_core=b,this.initFlvCoreEvt(this.core);else{const e=this.core._context||this.core.context;e&&this.initContextEvt(e)}this.commonParams.loudness_balance=0,this.preLoadedSize=0,this.cachePlaying.totalByteSize=0,this.reportStartPlay()}handleAbrSwitch(e){this.log.abr_switch.switch_index++,this.log.playing.abr_switch_count++;const t=Date.now()-(this.log.abr_session.timestamp||this.log.first_frame.timestamp);this.log.abr_switch.switch_interval=t,this.logmanager.push(Object.assign(this.log.abr_switch,e));const i=this.getFetchLoader();this.logmanager.push(Object.assign(this.log.abr_session,{bitrate:e.cur_bitrate,ave_download_speed:Math.round(1e3*((i||{}).totalByteSize||-1)/t),start_buffer:this.log.abr_session.after_buffer,end_buffer:e.cur_video_buffer_time,after_buffer:e.after_video_buffer_time,stall_count:this.log.abr_switch.stall_count,stall_time_per_100sec:this.log.abr_session.stall_time/t*100,stall_count_per_100sec:1e3*this.log.abr_switch.stall_count/t*100})),this.log.abr_switch.stall_count=0,this.log.abr_session.stall_time=0}handleDegrade(e){this.log.degrade.payload=e,this.logmanager.push(this.log.degrade,!0)}hiJackPlayerStart(){this.player._start=this.player.start;const{player:e}=this;e.start=()=>{try{if(e._start)return e._start.apply(e,Array.prototype.slice.call(arguments,0))}catch{}this.destroyed||this.handlePlayerComplete()}}handleTTFB(e){const{end:t,elapsed:i,url:s,responseUrl:a}=e||{};this.log.first_frame.ttfb=i||-1,this.log.first_frame.ttfb_end=t||0,this.log.first_frame.is_redirect=+(s!==a),this.log.play_result.is_redirect=this.log.first_frame.is_redirect}handleUrlChange(e){this.logmanager.push(Object.assign(this.log.play_url_change,{url:e,timestamp:g()}))}handleKeyframe(e){this.log.play_stop.is_firstframe_received=1,this.log.play_stop.firstframe_pts=e}handleSourceOpen(){this.log.source_opened.timestamp=g(),this.logmanager.push(this.log.source_opened)}handleBufferAppend(){this.log.source_updateend.timestamp=g(),this.logmanager.push(this.log.source_updateend)}handlePlayerPause(){Object.assign(this.log.pause,{timestamp:g(),...this.videoSize}),this.logmanager.push(this.log.pause,!0)}handlePlayerError(e){this.setCdnIp(),this.errorNumber=1;let t=e.errorType;const i=e.code||e.errorCode;Object.assign(this.log.play_error,{timestamp:g(),code:i||("parse"===t?31:21),info:e.ex||e.message||"",detail:JSON.stringify(e),...this.videoSize}),this.logmanager.push(this.log.play_error,!0),!this.destroyed&&(0===this.log.first_frame.first_frame_view&&(Object.assign(this.log.first_frame_failed,{code:i||("parse"===t?31:21),msg:e.ex||e.message}),void 0!==this.log.first_frame_failed.timestamp&&(this.log.first_frame_failed.timestamp=g()),this.logmanager.push(this.log.first_frame_failed,!0),this.log.play_result.is_threshold||(this.clearPlayResultTimer(),this.log.play_result.reason=e.ex||e.message,this.log.play_result.code=this.log.play_error.code,this.logmanager.push(this.log.play_result,!0))),this.options.error_report_stop?this.handleUserLeave():this.updatePlayStopParams())}handlePlayerLoadStream(e){if("string"!=typeof e)return;const{play_loadstream:t}=this.log;t.timestamp=g(),t.loadstream_url=e,this.logmanager.push(t)}handlePlayerLoadedStream(){const{play_stream_loaded:e}=this.log;e.timestamp=g(),this.logmanager.push(e)}handleSEIParsed(e){const{log:{playing:t,first_frame:i}}=this;if(100===e.code){let s;try{s=new TextDecoder("utf-8").decode(e.content)}catch{s=function(e){var t,i,s,a,r,o;for(t="",s=e.length,i=0;i<s;)switch(a=e[i++],a>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(a);break;case 12:case 13:r=e[i++],t+=String.fromCharCode((31&a)<<6|63&r);break;case 14:r=e[i++],o=e[i++],t+=String.fromCharCode((15&a)<<12|(63&r)<<6|63&o)}return t}(e.content)}s=function(e){let t=e;return['"app_data"','app_data"','canvas"','"canvas"','"live_sei_game_moment"',"live_sei_game_moment",'"ttls_live_scene"','ttls_live_scene"','trans_info"','"trans_info"'].some((i=>{const s=function(e,t="app_data"){if(!e)return"";const i=new RegExp(`^([\\w\\W]*)${t}.*`).exec(e);return(null==i?void 0:i[1])??""}(e,i);return!(!s||"{"===s||(t=`{${'"'!==i[0]?'"':""}${e.slice(s.length,e.lastIndexOf("}")+1)}`,0))}))||(t=e.slice(e.indexOf("{"),e.lastIndexOf("}")+1)),t}(s);try{const e=JSON.parse(s);if(!e.ts)return void(t.sei_string=s);this.core||(this.core=E(this.player)),this.core&&this.core.config.seiOnDemand?(t.sei_delay=this.ntpTime-e.ts,i.first_sei_delay=t.sei_delay,t.sei_buffer_delay=void 0,t.sei_network_delay=i.sei_network_delay=void 0):(t.sei_network_delay=this.ntpTime-e.ts,t.sei_buffer_delay=this.getPlayerBuffer(),t.sei_delay=t.sei_network_delay+t.sei_buffer_delay,i.sei_network_delay=t.sei_network_delay),t.sei_source=e.source,t.ntp_sync=this.options.ntp?1:0,t.ntp_delta=this.ntp_delta,i.ntp_sync=this.options.ntp?1:0,i.ntp_delta=this.ntp_delta}catch{t.sei_string=s}t.sei_delay?t.sei_string=void 0:t.sei_string=s}}handleSEILoudNessParsed(e){const{log:{first_frame:t}}=this;t.loudness_peak=e.sourcePeak,t.loudness_luft=e.sourceLuft,t.loudness_integrated=e.sourceIntegrated,t.loudness_shorterm=e.sourceShorterm,t.loudness_momentary=e.sourceMomentary}handleLoudnessBalanceStart(){this.commonParams.loudness_balance=1}handleMetaDataLoaded(e){this.log.play_metadata_loaded.timestamp=g(),this.log.play_metadata_loaded.metadata_type=e;let t=!1;if(this.core){const i=this.core._context||this.core.context;if(i){let s;if("video"===e?s=(i.getInstance("TRACKS")||{}).videoTrack:"audio"===e&&(s=(i.getInstance("TRACKS")||{}).audioTrack),s&&s.meta)if(t=!0,"video"===e){const e={codec:s.meta.codec,frameRate:s.meta.frameRate,timescale:s.meta.timescale};this.log.play_metadata_loaded.meta=e,this.commonParams.codec_type=this.log.play_metadata_loaded.codec=e.codec,this.commonParams.codec_support=u(e.codec),this.log.first_frame.video_codec=s.meta.codec,this.log.play_metadata_loaded.fps=s.meta.frameRate&&s.meta.frameRate.fps,s.meta.refSampleDuration?this.commonParams.fps=Math.round(1e3/s.meta.refSampleDuration):s.meta.frameRate&&(this.commonParams.fps=s.meta.frameRate.fps)}else this.log.play_metadata_loaded.meta=s.meta,this.log.play_metadata_loaded.codec=s.meta.codec,this.log.first_frame.audio_codec=s.meta.codec,this.log.first_frame.audioSampleRate=s.meta.sampleRate,this.log.first_frame.audioObjectType=s.meta.objectType,this.log.first_frame.audioChannelCount=s.meta.channelCount}}t||(this.log.play_metadata_loaded.meta=void 0,this.log.play_metadata_loaded.codec=void 0,"video"===e&&(this.log.playing.codec="unknown")),this.logmanager.push(this.log.play_metadata_loaded)}handleMetaDataLoadedForWebCodec(e,t){this.log.play_metadata_loaded.timestamp=g(),this.log.play_metadata_loaded.metadata_type=e;let i=!1;t&&(i=!0,this.log.play_metadata_loaded.meta=t,this.log.play_metadata_loaded.codec=t.codec,"video"===e?(this.commonParams.codec_type=t.codec,this.commonParams.codec_support=u(t.codec),this.log.play_metadata_loaded.fps=t.frameRate,this.log.first_frame.video_codec=t.codec,this.commonParams.fps=t.frameRate):(this.log.first_frame.audio_codec=t.codec,this.log.first_frame.audioSampleRate=t.sampleRate,this.log.first_frame.audioObjectType=t.objectType,this.log.first_frame.audioChannelCount=t.channelCount)),i||(this.log.play_metadata_loaded.meta=void 0,this.log.play_metadata_loaded.codec=void 0,"video"===e&&(this.log.playing.codec="unknown")),this.logmanager.push(this.log.play_metadata_loaded)}handleDemuxError(e){this.log.play_demux_error.msg=e,this.logmanager.push(this.log.play_demux_error)}handleAVUnsync(e){Object.assign(this.log.play_av_unsync,e||{}),this.log.play_av_unsync.timestamp=g(),this.logmanager.push(this.log.play_av_unsync,!1)}handleDetectLargeGap(e,t){this.log.play_stream_discontinue.type=e,this.log.play_stream_discontinue.gap=t,this.logmanager.push(this.log.play_stream_discontinue)}initContextEvt(e){e._emitter.once("LOADER_RESPONSE_HEADERS",((e,t)=>{const i=t.get("X-Server-Ip");this.player&&(void 0!==this.player.hlsOps&&(this.log.play_stop.review_ts_count+=1),i&&(this.commonParams.cdn_ip=i))})),e._emitter.on("REMUX_METADATA",((e,t)=>{this.log.play_stop.meta=this.log.play_stop.meta||{},e&&(this.log.play_stop.meta[e]=t)})),e._emitter.on("LOADER_START__TO__TS_LOADER",(e=>{this.handlePlayerLoadStream(e)})),e._emitter.on("LOADER_START",(e=>{this.handlePlayerLoadStream(e)})),e._emitter.on("LOADER_COMPLETE",(e=>{this.handlePlayerLoadedStream(e)})),e._emitter.once("DEMUX_ERROR",((e,t)=>{t&&(this.log.play_demux_error.msg=t.message,this.handleDemuxError(t.message))})),e._emitter.on("METADATA_PARSED__TO__HLS_LIVE_CONTROLLER",(e=>{this.handleMetaDataLoaded(e)})),e._emitter.on("REMUX_METADATA",(e=>{this.handleMetaDataLoaded(e)})),e._emitter.on("DETECT_LARGE_GAP",((e,t)=>{this.handleDetectLargeGap(e,t)})),e._emitter.on("DETECT_AUDIO_GAP",((e,t)=>{this.logmanager.push(Object.assign({},this.log.play_audio_gap,{gap:e,silent_frame_count:t}))})),e._emitter.on("DETECT_AUDIO_OVERLAP",(e=>{this.logmanager.push(Object.assign({},this.log.play_audio_overlap,{gap:e}))}))}initFlvCoreEvt(e){if(this._flvCoreEvtBound)return;this._flvCoreEvtBound=!0;const t=e.constructor.FlvCoreEvent;e.once(t.RESPONSEHEADERS,this._onceFlvResponseHeaders),e.on(t.METADATA,this._onFlvMetadata)}handlePlayerComplete(){this.completed||(this.completed=!0,(this.player.config.autoplay||this.player.config.videoInit)&&this.reportStartPlay())}getPlayerBuffer(){let e=this.player.video.buffered;if(e){const t=Math.max(0,e.length-1);try{const i=Number.parseInt(1e3*(e.end(t)-this.player.video.currentTime));return this.log.playing.audio_buffer_time=this.log.playing.video_buffer_time=i,i}catch{return 0}}}setCdnIp(){if(this.commonParams.cdn_ip||!this.core)return;if(this.isWebCodec){const e=this.core.loader.responseHeader.get("X-Server-Ip");return void(e&&(this.commonParams.cdn_ip=e))}const e=this.core._context||this.core.context;if(!e)return;const t=e.getInstance("FETCH_LOADER")||e.getInstance("TS_LOADER");if(!t)return;const i=t.responseHeader;if(!i)return;const s=i.get("X-Server-Ip");s&&(this.commonParams.cdn_ip=s)}getFetchLoader(){if(this.core){if(this.isWebCodec)return this.core.loader;if(this.core){const e=this.core._context||this.core.context;return e?e.getInstance("FETCH_LOADER")||e.getInstance("TS_LOADER"):void 0}}}getPlayerDownloadSpeed(){const e=this.getFetchLoader();if(e)return Number.parseInt(e.currentSpeed)}collectDowloadSpeed(){const e=this.getFetchLoader();if(!e)return;let t;this.preLoadedSize&&e.totalByteSize>=this.preLoadedSize&&(t=Math.round(1e3*(e.totalByteSize-this.preLoadedSize)/(Date.now()-this.preCollectSpeedTime))),this.preLoadedSize=e.totalByteSize,this.preCollectSpeedTime=Date.now(),t&&(this.log.playing.download_speed_array?this.log.playing.download_speed_array.push(t):this.log.playing.download_speed_array=[t]),this.collectDownloadSpeedTimer=setTimeout((()=>{this.collectDowloadSpeed()}),this.options.downloadSpeedInterval)}getPlayerQuality(e){const{video:t}=this.player;if(t.getVideoPlaybackQuality){const i=t.getVideoPlaybackQuality();this.log.playing.drop_count=i.droppedVideoFrames-this.tempDroppedFrameCount,this.log.playing.drop_percent=(i.droppedVideoFrames-this.tempDroppedFrameCount)/(i.totalVideoFrames-this.tempTotalFrameCount),this.log.play_stop.drop_percent=i.droppedVideoFrames/i.totalVideoFrames,e&&!this.commonParams.is_wasm&&(this.log.playing.render_fps=Math.round((i.totalVideoFrames-i.droppedVideoFrames-this.tempTotalFrameCount+this.tempDroppedFrameCount)/e)),this.tempDroppedFrameCount=i.droppedVideoFrames,this.tempTotalFrameCount=i.totalVideoFrames}}async getExtraStats(e,t){return new Promise((i=>{if(!S)return i();try{e.getStats((e=>{e.result().forEach((e=>{const i={};e.names().forEach((function(t){i[t]=e.stat(t)})),i.id=e.id,i.type=e.type,i.timestamp=e.timestamp,"ssrc"===e.type?(null!=i.googAccelerateRate&&(t.accelerate_rate=i.googAccelerateRate),"audio"===i.mediaType?(t.audio_jitter_buffer_ms=i.googJitterBufferMs,t.audio_rtt_ms=i.googRtt,t.expand_rate=i.googExpandRate):"video"===i.mediaType&&(t.video_rtt_ms=i.googRtt,t.video_codec_name=i.googCodecName)):"VideoBwe"===e.type&&(t.video_recv_retransmit_bps=i.googRetransmitBitrate)})),i()}))}catch{i()}}))}reportPlaying(e){if(this.core){const e=this.core._context||this.core.context;if(e){const{videoTrack:t}=e.getInstance("TRACKS")||{};!t||!t.meta||(t.meta.refSampleDuration?this.commonParams.fps=Math.round(1e3/t.meta.refSampleDuration):t.meta.frameRate&&(this.commonParams.fps=t.meta.frameRate.fps))}if(this.core.transferCost){const{demuxCost:e,remuxCost:t,appendCost:i}=this.core.transferCost;Object.assign(this.log.playing,{demuxCost:e-this.cachePlaying.demuxCost,remuxCost:t-this.cachePlaying.remuxCost,appendCost:i-this.cachePlaying.appendCost}),Object.assign(this.cachePlaying,this.core.transferCost)}}this.log.playing.index++,this.log.playing.playing_index++;const t=this.log.playing.timestamp||g();let i=0;this.inWaitingStart&&this.inWaitingStart<g()&&(i=Math.min(this.options.playingInterval||this.log.playing.play_time,g()-Math.max(this.inWaitingStart,t))),this.getPlayerBuffer(),this.options.downloadSpeedInterval||(this.log.playing.current_speed=this.getPlayerDownloadSpeed());const s=g(),a=s-t,r=(i>200?i:0)+this.log.playing.stall_time,o=(i>200?1:0)+this.log.playing.stall_count;if(this.options.aggregationDowngradeStallTime&&(this.log.playing.aggregation_downgrade_stall=(i>this.options.aggregationDowngradeStallTime?i:0)+(this.log.playing.aggregation_downgrade_stall||0)),Object.assign(this.log.playing,{timestamp:s,stop_time:s,duration:e?0:a/1e3,stall_time_per_100sec:r/a*100,stall_count_per_100sec:1e3*o/a*100,stall_count:o,stall_time:r,accum_stall_time:this.log.playing.accum_stall_time+r,accum_stall_count:this.log.playing.accum_stall_count+o,accum_play_time:this.log.playing.accum_play_time+a,play_current_time:this.player.currentTime,playback_rate:this.player.playbackRate,...this.videoSize}),this.getPlayerQuality(this.log.playing.duration),this.player.plugins.abr&&this.player.plugins.abr.algo){const{_openTimeMs:e,abr_time_offset_set:t,abr_cur_bitrate_set:i,abr_pred_bitrate_set:s,abr_speed_set:a,abr_player_buffer_set:r,abr_stall_status_set:o}=this.player.plugins.abr.algo;Object.assign(this.log.playing,{abr_bitrate_map:this.player.plugins.abr.config.urls,abr_start_timestamp:e,abr_time_offset_set:t,abr_cur_bitrate_set:i,abr_pred_bitrate_set:s,abr_speed_set:a,abr_player_buffer_set:r,abr_stall_status_set:o,abr_suffix_ids:this.player.plugins.abr.suffixIds}),this.player.plugins.abr.algo.resetCollect&&this.player.plugins.abr.algo.resetCollect()}this.logmanager.push(Object.assign({},this.log.playing,{play_time:e?0:a,playing_interval:e?0:a}),!0),this.log.playing.download_speed_array=[],this.log.playing.stall_time=0,this.log.playing.stall_count=0,this.log.playing.abr_switch_count=0,this.log.playing.ratechange_count=0,this.log.playing.render_fps=-1,this.options.aggregationDowngradeStallTime&&(this.log.playing.aggregation_downgrade_stall=0)}handlePlayerPlaying(){if(!(this.player&&this.player.video.readyState<3)){if(this.player.off("playing",this.handlePlayerPlaying),this.player.off("timeupdate",this.handlePlayerPlaying),this.player.paused)return void this.handleVideopause();clearTimeout(this.collectDownloadSpeedTimer),this.options.downloadSpeedInterval&&this.collectDowloadSpeed(),this.reportPlaying(!0),this.clearPlayingInterval(),this.intervalId=setTimeout(this.cycleReportPlaying,1e3),this.handleVideoplaying(),this.started||this.reportStartPlay(),this.saveBuffered()}}handlePlayerReady(){this.log.start_play.start_play_time=g(),this.player.config.autoplay&&this.reportStartPlay(),this.options.playResultThreshold&&(this.log.play_result.threshold=this.options.playResultThreshold),this.clearPlayResultTimer(),this.log.play_result.start=g(),this.playResultTimer=setTimeout((()=>{this.log.play_result.timestamp>=this.log.play_result.start||(this.log.play_result.is_threshold=1,this.log.play_result.code=9999,this.logmanager.push(this.log.play_result,!0),this.log.first_frame_failed.code=9999,this.log.first_frame_failed.is_threshold=1,this.logmanager.push(this.log.first_frame_failed,!0))}),this.log.play_result.threshold)}handlePlayerWaiting(){if(this.inWaitingStart||!this.log.first_frame.timestamp)return;const e=g();this.log.stall.timestamp=this.inWaitingStart=this.log.stall.stall_start=e,this.log.stall_start.ready_state=this.log.stall.ready_state=this.player.video.readyState,this.log.stall_start.timestamp=e,this.log.stall_start.stall_start_time=e,this.log.stall_start.video_buffer_time=this.player.video.readyState,this.log.stall_start.play_current_time=this.player.currentTime,this.log.stall.play_current_time=this.player.currentTime,this.log.stall_start.buffered=this.getBuffered(),this.log.stall.buffered=this.log.stall_start.buffered,this.log.stall.is_seeking=this.player.seeking?1:0,this.log.stall.remain_buffer=Number(this._getRemainBuffer().toFixed(2)),this.log.stall.current_speed=this.getPlayerDownloadSpeed(),this.log.stall.start_diff=e-this.log.first_frame.timestamp,this.log.abr_switch.timestamp&&(this.log.stall.abr_diff=e-this.log.abr_switch.timestamp),Object.assign(this.log.stall_start,this.videoSize)}handleVideoseeking(){!this.player||!this.player.video||this.inWaitingStart&&this.player.video.duration<1/0&&(this.inWaitingStart=0)}handleVideoseeked(){!this.player||!this.player.video||this.inWaitingStart&&this.player.video.duration<1/0&&(this.inWaitingStart=0,this.log.play_stop.stall_count>0&&this.log.play_stop.stall_count--)}handleVideoplay(){this.reportStartPlay(),this.removeVideoEvt("play",this.handleVideoplay)}handleVideotimeupdate(){Math.abs(this.player.currentTime-this.log.stall_start.play_current_time)>.2&&this.stallEnd(),this.saveBuffered()}handleVideocanplay(){this.setCdnIp(),this.stallEnd(),this.reportFirstframe()}handleVideoplaying(){this.stallEnd(),this.log.play_stop.is_stream_received=1;const e=g();this.reportStartPlay(),this.log.first_frame.start=e}stallEnd(){const e=g();if(this.inWaitingStart){const t=e-this.inWaitingStart;t>200&&(this.log.abr_switch.stall_count++,this.log.play_stop.stall_count++,this.log.play_stop.stall_time+=e-this.inWaitingStart,this.log.playing.stall_time+=e-Math.max(this.inWaitingStart,this.log.playing.timestamp),this.log.abr_session.stall_time+=e-this.inWaitingStart,this.log.stall.stall_end=e,this.log.stall.stall_duration=this.log.stall.stall_end-this.log.stall.stall_start,this.log.stall.timestamp=g(),this.log.playing.timestamp<=this.inWaitingStart+200&&this.log.playing.stall_count++,Object.assign(this.log.stall,{...this.videoSize}),this.logmanager.push(this.log.stall,!0)),this.options.aggregationDowngradeStallTime&&t>this.options.aggregationDowngradeStallTime&&(this.log.playing.aggregation_downgrade_stall=(this.log.playing.aggregation_downgrade_stall||0)+(e-Math.max(this.inWaitingStart,this.log.playing.timestamp)))}this.inWaitingStart=0}handleVideoloadeddata(){this.reportFirstframe()}handleVideoratechange(){this.log.playing.speed_switch_count++,this.log.playing.speed_switch_info=this.player.video.playbackRate}handleVideoended(){this.clearPlayingInterval(),Object.assign(this.log.playing,{is_last:1}),this.reportPlaying()}handleVideoerror(){if(this.isWebCodec)return;this.errorNumber=1;const e=this.player.video.error;Object.assign(this.log.play_error,{timestamp:g(),...this.videoSize,...e&&{code:e.code,info:e.message}}),this.logmanager.push(this.log.play_error,!0),(()=>{0===this.log.first_frame.first_frame_view&&!this.log.first_frame_failed.code&&e&&(this.log.first_frame_failed.code=e.code,this.log.first_frame_failed.msg=A[e.code],void 0!==this.log.first_frame_failed.timestamp&&(this.log.first_frame_failed.timestamp=g()),this.logmanager.push(this.log.first_frame_failed,!0),this.log.play_result.is_threshold||(this.log.play_result.reason=A[e.code],this.log.play_result.code=e.code,this.clearPlayResultTimer(),this.logmanager.push(this.log.play_result,!0))),this.options.error_report_stop?this.handleUserLeave():this.updatePlayStopParams()})()}handleVideopause(){this.stallEnd(),this.clearPlayingInterval(),this.player.once("playing",this.handlePlayerPlaying),this.player.once("timeupdate",this.handlePlayerPlaying)}destroyFunc(e){if(!this.destroyed&&(this._flvCoreEvtBound=!1,(!e||e instanceof Event)&&this.handleUserLeave(),this.destroyed=!0,"pc"===o.device?window.removeEventListener("beforeunload",this.destroyFunc):"mobile"===o.device&&(window.removeEventListener("beforeunload",this.destroyFunc),window.removeEventListener("pagehide",this.destroyFunc)),document.removeEventListener("visibilitychange",this._visibilityChannged),R.forEach((e=>{this.removeVideoEvt(e,this[`handleVideo${e}Evt`])})),this.player)){if(this.player._start&&(this.player.start=this.player._start,delete this.player._start),this.player.off("destroy",this.destroyFunc),this.player.off("complete",this.handlePlayerComplete),this.player.off("playing",this.handlePlayerPlaying),this.player.off("timeupdate",this.handlePlayerPlaying),this.player.off("ready",this.handlePlayerReady),this.player.off("waiting",this.handlePlayerWaiting),this.player.off("largeavgap",this.handleAVUnsync),this.player.off("error",this.handlePlayerError),this.player.off("SEI_PARSED",this.handleSEIParsed),this.player.off("SEI_LOUDNESS",this.handleSEILoudNessParsed),this.player.off("pause",this.handlePlayerPause),this.player.off("ttfb",this.handleTTFB),this.player.off("urlchange",this.handleUrlChange),this.player.off("isKeyframe",this.handleKeyframe),this.player.off("sourceopen",this.handleSourceOpen),this.player.off("bufferappend",this.handleBufferAppend),this.player.off("degrade",this.handleDegrade),this.player.off("loadstart",this.handleLoadStart),this.player.off("ratechange",this.handlePlaybackrateChange),this.player.off("ended",this.handlePlayerEnded),this.player.off("chaseframe",this.handleChaseFrame),this.player.off("user_action",this.handleUserAction),this.player.off("retry",this.handleRetry),this.player.off("switch_start",this.handleSwitchStart),this.player.off("switch_completed",this.handleSwitchComplete),this.player.off("switch_error",this.handleSwitchError),this.player.off("streamexception",this.handleStreamException),this.player.off("catch_audioctx_error",this.handleCatchAudioCtxError),this.isWebCodec){const e=E(this.player);e.off(e.constructor.FlvCoreEvent.METADATA,this._onFlvMetadata)}const e=this.player.plugins.abr;e&&e.off("abr_switch",this.handleAbrSwitch),this.clearPlayingInterval(),this.clearPlayResultTimer(),this._player=null}}handleUserLeave(){this.destroyed||!this.started||(this.updatePlayStopParams(),this.reportPlayStop(),this.clearPlayingInterval(),this.removeWindowListener())}saveBuffered(){try{const e=this.getBuffered();e&&e.length&&(this.log.play_stop.buffered=e)}catch{}}getBuffered(){try{const e=[],{video:t}=this.player;for(let i=0;i<t.buffered.length;i++)e.push([t.buffered.start(i),t.buffered.end(i)]);return e}catch{}}_getRemainBuffer(){var e,t;try{const i=this.getBuffered(),s=(null==(t=null==(e=this.player)?void 0:e.video)?void 0:t.currentTime)||0;for(let e=0,t=i.length;e<t;e++)if(i[e][0]<s&&s<i[e][1])return i[e][1]-s}catch{}return 0}reportPlayStop(){this.log.play_stop.play_current_time=this.player.currentTime||this.log.playing.play_current_time,this.saveBuffered(),this.logmanager.push(this.log.play_stop,!0)}reportFirstframe(){if(this.firstFrameViewed)return;this.log.play_metadata_loaded.timestamp||(this.handleMetaDataLoaded("video"),this.handleMetaDataLoaded("audio")),this.firstFrameViewed=!0;const e=g();if(Object.assign(this.log.first_frame,{first_frame_view:e-(this.log.start_play.start_play_time||e),timestamp:e,...this.videoSize}),this.log.first_frame.ttfb_end&&(this.log.first_frame.ttdb=e-this.log.first_frame.ttfb_end),this.isWebCodec){const e=this.core.firstframeInfo;this.log.first_frame.time_worker_init=Math.floor(e.workerInit),this.log.first_frame.time_loadstream_start=Math.floor(e.loadStream),this.log.first_frame.time_decoder_init=Math.floor(e.decoderInited-e.loadStream),this.log.first_frame.time_render_init=Math.floor(e.renderInited-e.loadStream),this.log.first_frame.time_first_sample=Math.floor(e.firstSample-e.loadStream),this.log.first_frame.time_first_aframe=Math.floor(e.firstAFrame-e.loadStream),this.log.first_frame.time_first_vframe=Math.floor(e.firstVFrame-e.loadStream)}this.log.first_frame.buffered=this.getPlayerBuffer(),this.log.first_frame.sei_network_delay&&(this.log.first_frame.sei_buffer_delay=this.log.first_frame.buffered,this.log.first_frame.first_sei_delay=this.log.first_frame.sei_buffer_delay+this.log.first_frame.sei_network_delay),this.core&&this.core.transferCost&&Object.assign(this.log.first_frame,this.core.transferCost),this.logmanager.push(this.log.first_frame,!0),this.clearPlayResultTimer(),this.log.play_result.result=1,this.logmanager.push(this.log.play_result,!0),this.log.play_stop.is_stream_received=1}setMarkScore(e){if(e){const{performance:i,net:s}=e,{cpu:a,memory:r,gpu:o}=i,{downlink:n,performanceNet:l}=s,{cpuCoreNumber:h,decodeImg:d,timer:c}=a;this.commonParams.decode_img_fps=d.origin,this.commonParams.set_timer_cost=c.origin,this.commonParams.performance_speed=l.origin,this.commonParams.cpu_score=a.score,this.commonParams.memory_score=r.score,this.commonParams.bandwidth_score=s.score,this.commonParams.device_score=i.score,this.commonParams.cpu_core_number=h.origin,this.commonParams.memory_usage=r.origin,this.commonParams.network_downlink=n.origin,this.commonParams.gpu_vendor=(null==o?void 0:o.origin)||"";try{f=t=e,localStorage.setItem("xg-device-score",t)}catch{}}var t}updatePlayStopParams(){const e=(e=>{const t=performance.getEntriesByType("resource").filter((t=>t.name===e));if(t.length){const e=t[0],i=t[t.length-1];return{dns_parse_time:Number.parseInt(e.domainLookupEnd-e.domainLookupStart),redirect:Number.parseInt(e.redirectEnd-e.redirectStart),ttfb:Number.parseInt(i.responseStart-i.requestStart)}}return{dns_parse_time:-1,redirect:-1,ttfb:-1}})(this._url);let t=g();this.playedTime=t-this.log.start_play.start_play_time;const{play_stop:i}=this.log;Object.assign(i,{...0===i.stall_count&&{stall_time:0}}),this.inWaitingStart&&t-this.inWaitingStart>200&&(i.stall_time+=t-this.inWaitingStart),this.inWaitingStart&&t-this.inWaitingStart>this.stallOut?this.log.play_stop.code=-100015:this.log.play_stop.code=0,this.inWaitingStart=0,Object.assign(i,{stall_time_per_100sec:i.stall_time/this.playedTime*100,stall_count_per_100sec:1e3*i.stall_count/this.playedTime*100,...e}),0===this.log.play_stop.stall_count_per_100sec&&(this.log.play_stop.stall_time_per_100sec=0),!(this.log.play_stop.stall_time_per_100sec>100||this.log.play_stop.stall_time_per_100sec<0)&&(this.log.playing.index?(Object.assign(this.log.playing,{is_last:1}),this.reportPlaying()):(this.log.play_stop.error_code=this.log.play_error.code,this.log.play_stop.error_info=this.log.play_error.info),t=g(),Object.assign(i,{timestamp:t,stop_time:t,duration:this.playedTime/1e3,play_time:this.playedTime/1e3,...this.videoSize}),0===this.errorNumber&&(i.play_time_on_no_frame=i.stop_time-this.log.start_play.start_play_time))}clearPlayingInterval(){this.intervalId&&(clearTimeout(this.intervalId),this.intervalId=null)}clearPlayResultTimer(){clearTimeout(this.playResultTimer)}destroy(e){this.destroyFunc(!e)}bindVideoEvt(e,t){this.player&&this.player.video.addEventListener(e,t,!1)}removeVideoEvt(e,t){!this.player||!this.player.video||this.player.video.removeEventListener(e,t,!1)}send(e,t){this.logmanager.send(e,t)}}class w{constructor(e){a(this,"options"),a(this,"logger"),a(this,"restart",(e=>{var t,i;this.destroy("string"!=typeof e&&!!e),this.logger=new T(this.options),this.bindUrlChange(),null==(t=this.logger)||t.reportStartPlay(),null==(i=this.logger)||i.handlePlayerComplete()})),this.options=e,this.logger=new T(e),this.bindUrlChange()}setMarkScore(e){var t;typeof document>"u"||null==(t=this.logger)||t.setMarkScore(e)}bindUrlChange(){this.options&&this.options.player&&!this.options.manual_restart&&this.options.player.on("urlchange",this.restart)}setNTP(e){var t;null==(t=this.logger)||t.setNTP(e)}updateExt(e){var t;this.options.ext=Object.assign(this.options.ext||{},e),null==(t=this.logger)||t.updateExt(e)}updateOptions(e){var t;Object.assign(this.options,e),null==(t=this.logger)||t.updateOptions(e)}destroy(e){var t;null==(t=this.logger)||t.destroy(e),this.logger=null,this.options&&this.options.player&&!this.options.manual_restart&&this.options.player.off("urlchange",this.restart)}}}}]);